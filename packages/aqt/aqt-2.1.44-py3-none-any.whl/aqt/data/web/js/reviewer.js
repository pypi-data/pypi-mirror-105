"use strict";
/* Copyright: Ankitects Pty Ltd and contributors
 * License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var ankiPlatform = "desktop";
var typeans;
var _updatingQueue = Promise.resolve();
var qFade = 0;
var aFade = 0;
var onUpdateHook;
var onShownHook;
function _runHook(arr) {
    const promises = [];
    for (let i = 0; i < arr.length; i++) {
        promises.push(arr[i]());
    }
    return Promise.all(promises);
}
function _queueAction(action) {
    _updatingQueue = _updatingQueue.then(action);
}
function _updateQA(html, fadeTime, onupdate, onshown) {
    return __awaiter(this, void 0, void 0, function* () {
        onUpdateHook = [onupdate];
        onShownHook = [onshown];
        const qa = $("#qa");
        const renderError = (kind) => (error) => {
            const errorMessage = String(error).substring(0, 2000);
            const errorStack = String(error.stack).substring(0, 2000);
            qa.html(`Invalid ${kind} on card: ${errorMessage}\n${errorStack}`.replace(/\n/g, "<br />"));
        };
        // fade out current text
        yield qa.fadeTo(fadeTime, 0).promise();
        // update text
        try {
            qa.html(html);
        }
        catch (error) {
            renderError("HTML")(error);
        }
        yield _runHook(onUpdateHook);
        // wait for mathjax to ready
        yield MathJax.startup.promise
            .then(() => {
            // clear MathJax buffers from previous typesets
            MathJax.typesetClear();
            return MathJax.typesetPromise(qa.slice(0, 1));
        })
            .catch(renderError("MathJax"));
        // defer display for up to 100ms to allow images to load
        yield Promise.race([allImagesLoaded(), new Promise((r) => setTimeout(r, 100))]);
        // and reveal when processing is done
        yield qa.fadeTo(fadeTime, 1).promise();
        yield _runHook(onShownHook);
    });
}
function _showQuestion(q, bodyclass) {
    _queueAction(() => _updateQA(q, qFade, function () {
        // return to top of window
        window.scrollTo(0, 0);
        document.body.className = bodyclass;
    }, function () {
        // focus typing area if visible
        typeans = document.getElementById("typeans");
        if (typeans) {
            typeans.focus();
        }
    }));
}
function _showAnswer(a, bodyclass) {
    _queueAction(() => _updateQA(a, aFade, function () {
        if (bodyclass) {
            //  when previewing
            document.body.className = bodyclass;
        }
        // avoid scrolling to the answer until images load, even if it
        // takes more than 100ms
        allImagesLoaded().then(scrollToAnswer);
    }, function () { }));
}
const _flagColours = {
    1: "#ff6666",
    2: "#ff9900",
    3: "#77ff77",
    4: "#77aaff",
};
function _drawFlag(flag) {
    var elem = $("#_flag");
    if (flag === 0) {
        elem.hide();
        return;
    }
    elem.show();
    elem.css("color", _flagColours[flag]);
}
function _drawMark(mark) {
    var elem = $("#_mark");
    if (!mark) {
        elem.hide();
    }
    else {
        elem.show();
    }
}
function _typeAnsPress() {
    if (window.event.keyCode === 13) {
        pycmd("ans");
    }
}
function _emulateMobile(enabled) {
    const list = document.documentElement.classList;
    if (enabled) {
        list.add("mobile");
    }
    else {
        list.remove("mobile");
    }
}
function allImagesLoaded() {
    return Promise.all(Array.from(document.getElementsByTagName("img")).map(imageLoaded));
}
function imageLoaded(img) {
    if (img.complete) {
        return;
    }
    return new Promise((resolve) => {
        img.addEventListener("load", () => resolve());
        img.addEventListener("error", () => resolve());
    });
}
function scrollToAnswer() {
    var _a;
    (_a = document.getElementById("answer")) === null || _a === void 0 ? void 0 : _a.scrollIntoView();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV2aWV3ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9xdC9hcXQvZGF0YS93ZWIvanMvcmV2aWV3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO2tGQUNrRjs7Ozs7Ozs7OztBQU1sRixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUM7QUFDN0IsSUFBSSxPQUFPLENBQUM7QUFDWixJQUFJLGNBQWMsR0FBa0IsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBRXRELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUVkLElBQUksWUFBNkIsQ0FBQztBQUNsQyxJQUFJLFdBQTRCLENBQUM7QUFFakMsU0FBUyxRQUFRLENBQUMsR0FBb0I7SUFDbEMsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO0lBRXBCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2pDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUMzQjtJQUVELE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsTUFBZ0I7SUFDbEMsY0FBYyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDakQsQ0FBQztBQUVELFNBQWUsU0FBUyxDQUNwQixJQUFZLEVBQ1osUUFBZ0IsRUFDaEIsUUFBa0IsRUFDbEIsT0FBaUI7O1FBRWpCLFlBQVksR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLFdBQVcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhCLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNw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QUNMLENBQUM7QUFFRCxTQUFTLGVBQWU7SUFDcEIsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUNkLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUNwRSxDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQXFCO0lBQ3RDLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRTtRQUNkLE9BQU87S0FDVjtJQUNELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUMzQixHQUFHLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDOUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELFNBQVMsY0FBYzs7SUFDbkIsTUFBQSxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQywwQ0FBRSxjQUFjLEdBQUc7QUFDeEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIENvcHlyaWdodDogQW5raXRlY3RzIFB0eSBMdGQgYW5kIGNvbnRyaWJ1dG9yc1xuICogTGljZW5zZTogR05VIEFHUEwsIHZlcnNpb24gMyBvciBsYXRlcjsgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2FncGwuaHRtbCAqL1xuXG5kZWNsYXJlIHZhciBNYXRoSmF4OiBhbnk7XG5cbnR5cGUgQ2FsbGJhY2sgPSAoKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcblxudmFyIGFua2lQbGF0Zm9ybSA9IFwiZGVza3RvcFwiO1xudmFyIHR5cGVhbnM7XG52YXIgX3VwZGF0aW5nUXVldWU6IFByb21pc2U8dm9pZD4gPSBQcm9taXNlLnJlc29sdmUoKTtcblxudmFyIHFGYWRlID0gMDtcbnZhciBhRmFkZSA9IDA7XG5cbnZhciBvblVwZGF0ZUhvb2s6IEFycmF5PENhbGxiYWNrPjtcbnZhciBvblNob3duSG9vazogQXJyYXk8Q2FsbGJhY2s+O1xuXG5mdW5jdGlvbiBfcnVuSG9vayhhcnI6IEFycmF5PENhbGxiYWNrPik6IFByb21pc2U8dm9pZFtdPiB7XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goYXJyW2ldKCkpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG59XG5cbmZ1bmN0aW9uIF9xdWV1ZUFjdGlvbihhY3Rpb246IENhbGxiYWNrKTogdm9pZCB7XG4gICAgX3VwZGF0aW5nUXVldWUgPSBfdXBkYXRpbmdRdWV1ZS50aGVuKGFjdGlvbik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIF91cGRhdGVRQShcbiAgICBodG1sOiBzdHJpbmcsXG4gICAgZmFkZVRpbWU6IG51bWJlcixcbiAgICBvbnVwZGF0ZTogQ2FsbGJhY2ssXG4gICAgb25zaG93bjogQ2FsbGJhY2tcbik6IFByb21pc2U8dm9pZD4ge1xuICAgIG9uVXBkYXRlSG9vayA9IFtvbnVwZGF0ZV07XG4gICAgb25TaG93bkhvb2sgPSBbb25zaG93bl07XG5cbiAgICBjb25zdCBxYSA9ICQoXCIjcWFcIik7XG4gICAgY29uc3QgcmVuZGVyRXJyb3IgPSAoa2luZDogc3RyaW5nKSA9PiAoZXJyb3I6IEVycm9yKTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IFN0cmluZyhlcnJvcikuc3Vic3RyaW5nKDAsIDIwMDApO1xuICAgICAgICBjb25zdCBlcnJvclN0YWNrID0gU3RyaW5nKGVycm9yLnN0YWNrKS5zdWJzdHJpbmcoMCwgMjAwMCk7XG5cbiAgICAgICAgcWEuaHRtbChcbiAgICAgICAgICAgIGBJbnZhbGlkICR7a2luZH0gb24gY2FyZDogJHtlcnJvck1lc3NhZ2V9XFxuJHtlcnJvclN0YWNrfWAucmVwbGFjZShcbiAgICAgICAgICAgICAgICAvXFxuL2csXG4gICAgICAgICAgICAgICAgXCI8YnIgLz5cIlxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH07XG5cbiAgICAvLyBmYWRlIG91dCBjdXJyZW50IHRleHRcbiAgICBhd2FpdCBxYS5mYWRlVG8oZmFkZVRpbWUsIDApLnByb21pc2UoKTtcblxuICAgIC8vIHVwZGF0ZSB0ZXh0XG4gICAgdHJ5IHtcbiAgICAgICAgcWEuaHRtbChodG1sKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZW5kZXJFcnJvcihcIkhUTUxcIikoZXJyb3IpO1xuICAgIH1cblxuICAgIGF3YWl0IF9ydW5Ib29rKG9uVXBkYXRlSG9vayk7XG5cbiAgICAvLyB3YWl0IGZvciBtYXRoamF4IHRvIHJlYWR5XG4gICAgYXdhaXQgTWF0aEpheC5zdGFydHVwLnByb21pc2VcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gY2xlYXIgTWF0aEpheCBidWZmZXJzIGZyb20gcHJldmlvdXMgdHlwZXNldHNcbiAgICAgICAgICAgIE1hdGhKYXgudHlwZXNldENsZWFyKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBNYXRoSmF4LnR5cGVzZXRQcm9taXNlKHFhLnNsaWNlKDAsIDEpKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlbmRlckVycm9yKFwiTWF0aEpheFwiKSk7XG5cbiAgICAvLyBkZWZlciBkaXNwbGF5IGZvciB1cCB0byAxMDBtcyB0byBhbGxvdyBpbWFnZXMgdG8gbG9hZFxuICAgIGF3YWl0IFByb21pc2UucmFjZShbYWxsSW1hZ2VzTG9hZGVkKCksIG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDEwMCkpXSk7XG5cbiAgICAvLyBhbmQgcmV2ZWFsIHdoZW4gcHJvY2Vzc2luZyBpcyBkb25lXG4gICAgYXdhaXQgcWEuZmFkZVRvKGZhZGVUaW1lLCAxKS5wcm9taXNlKCk7XG4gICAgYXdhaXQgX3J1bkhvb2sob25TaG93bkhvb2spO1xufVxuXG5mdW5jdGlvbiBfc2hvd1F1ZXN0aW9uKHE6IHN0cmluZywgYm9keWNsYXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBfcXVldWVBY3Rpb24oKCkgPT5cbiAgICAgICAgX3VwZGF0ZVFBKFxuICAgICAgICAgICAgcSxcbiAgICAgICAgICAgIHFGYWRlLFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIHJldHVybiB0byB0b3Agb2Ygd2luZG93XG4gICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDApO1xuXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc05hbWUgPSBib2R5Y2xhc3M7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIGZvY3VzIHR5cGluZyBhcmVhIGlmIHZpc2libGVcbiAgICAgICAgICAgICAgICB0eXBlYW5zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0eXBlYW5zXCIpO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlYW5zKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVhbnMuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBfc2hvd0Fuc3dlcihhOiBzdHJpbmcsIGJvZHljbGFzczogc3RyaW5nKTogdm9pZCB7XG4gICAgX3F1ZXVlQWN0aW9uKCgpID0+XG4gICAgICAgIF91cGRhdGVRQShcbiAgICAgICAgICAgIGEsXG4gICAgICAgICAgICBhRmFkZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoYm9keWNsYXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICB3aGVuIHByZXZpZXdpbmdcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc05hbWUgPSBib2R5Y2xhc3M7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gYXZvaWQgc2Nyb2xsaW5nIHRvIHRoZSBhbnN3ZXIgdW50aWwgaW1hZ2VzIGxvYWQsIGV2ZW4gaWYgaXRcbiAgICAgICAgICAgICAgICAvLyB0YWtlcyBtb3JlIHRoYW4gMTAwbXNcbiAgICAgICAgICAgICAgICBhbGxJbWFnZXNMb2FkZWQoKS50aGVuKHNjcm9sbFRvQW5zd2VyKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7fVxuICAgICAgICApXG4gICAgKTtcbn1cblxuY29uc3QgX2ZsYWdDb2xvdXJzID0ge1xuICAgIDE6IFwiI2ZmNjY2NlwiLFxuICAgIDI6IFwiI2ZmOTkwMFwiLFxuICAgIDM6IFwiIzc3ZmY3N1wiLFxuICAgIDQ6IFwiIzc3YWFmZlwiLFxufTtcblxuZnVuY3Rpb24gX2RyYXdGbGFnKGZsYWc6IDAgfCAxIHwgMiB8IDMgfCA0KTogdm9pZCB7XG4gICAgdmFyIGVsZW0gPSAkKFwiI19mbGFnXCIpO1xuICAgIGlmIChmbGFnID09PSAwKSB7XG4gICAgICAgIGVsZW0uaGlkZSgpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGVsZW0uc2hvdygpO1xuICAgIGVsZW0uY3NzKFwiY29sb3JcIiwgX2ZsYWdDb2xvdXJzW2ZsYWddKTtcbn1cblxuZnVuY3Rpb24gX2RyYXdNYXJrKG1hcms6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB2YXIgZWxlbSA9ICQoXCIjX21hcmtcIik7XG4gICAgaWYgKCFtYXJrKSB7XG4gICAgICAgIGVsZW0uaGlkZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW0uc2hvdygpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gX3R5cGVBbnNQcmVzcygpOiB2b2lkIHtcbiAgICBpZiAoKHdpbmRvdy5ldmVudCBhcyBLZXlib2FyZEV2ZW50KS5rZXlDb2RlID09PSAxMykge1xuICAgICAgICBweWNtZChcImFuc1wiKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIF9lbXVsYXRlTW9iaWxlKGVuYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBsaXN0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdDtcbiAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgICBsaXN0LmFkZChcIm1vYmlsZVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsaXN0LnJlbW92ZShcIm1vYmlsZVwiKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGFsbEltYWdlc0xvYWRlZCgpOiBQcm9taXNlPHZvaWRbXT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgICAgQXJyYXkuZnJvbShkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImltZ1wiKSkubWFwKGltYWdlTG9hZGVkKVxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGltYWdlTG9hZGVkKGltZzogSFRNTEltYWdlRWxlbWVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmIChpbWcuY29tcGxldGUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgaW1nLmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsICgpID0+IHJlc29sdmUoKSk7XG4gICAgICAgIGltZy5hZGRFdmVudExpc3RlbmVyKFwiZXJyb3JcIiwgKCkgPT4gcmVzb2x2ZSgpKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gc2Nyb2xsVG9BbnN3ZXIoKTogdm9pZCB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbnN3ZXJcIik/LnNjcm9sbEludG9WaWV3KCk7XG59XG4iXX0=