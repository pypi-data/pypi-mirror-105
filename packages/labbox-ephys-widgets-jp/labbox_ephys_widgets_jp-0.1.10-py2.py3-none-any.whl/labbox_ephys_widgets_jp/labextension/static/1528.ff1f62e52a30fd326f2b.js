(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[1528],{11528:(e,t,i)=>{"use strict";i.r(t),i.d(t,{activate:()=>j});var n=i(63847),s=i(56271),c=i.n(s),r=i(91871),l=i(45829),o=i(88493),a=i(85155),d=i(47033);const u={paddingLeft:6,paddingRight:6,paddingTop:4,paddingBottom:4},m=e=>{const t=(0,s.useMemo)((()=>({width:e.width,height:e.height,overflow:"hidden"})),[e.width,e.height]),i=(0,s.useMemo)((()=>{const t=[];for(let i of e.customActions||[])t.push({type:i.type||"button",title:i.title,onClick:i.callback,icon:i.icon,selected:i.selected});return t}),[e.customActions]);return c().createElement("div",{className:"ViewToolBar",style:Object.assign({position:"absolute"},t)},i.map(((e,t)=>{if("button"===e.type){let i="inherit";return e.selected&&(i="primary"),c().createElement(d.IconButton,{title:e.title,onClick:e.onClick,key:t,color:i,style:u},e.icon)}return"divider"===e.type?c().createElement("hr",{key:t}):c().createElement("span",{key:t})})))};var g=i(45185),p=i(12240),b=i(49287),h=i(87001);const v=(0,g.createCalculationPool)({maxSimultaneous:6}),y=({sorting:e,curation:t,recording:i,unitId:n,selection:r,selectionDispatch:l,width:o,height:a,noiseLevel:d,customActions:u})=>{const{result:m,job:y}=(0,g.useHitherJob)("createjob_fetch_average_waveform_2",{sorting_object:e.sortingObject,recording_object:i.recordingObject,unit_id:(0,b.kN)(n,t,r.applyMerges)},{useClientCache:!0,calculationPool:v}),f=(0,s.useMemo)((()=>({})),[]);if(!m)return c().createElement(p.Z,{job:y,width:o,height:a});const j=r.visibleElectrodeIds,E=m.channel_ids.filter((e=>!j||j.includes(e))),S=m.channel_locations.filter(((e,t)=>!j||j.includes(m.channel_ids[t])));return c().createElement(h.Z,{waveform:m.average_waveform,layoutMode:r.waveformsMode||"geom",noiseLevel:d,electrodeIds:E,electrodeLocations:S,samplingFrequency:m.sampling_frequency,width:o,height:a,selection:r,customActions:u,selectionDispatch:l,electrodeOpts:f})},f=e=>{const{recording:t,sorting:i,curation:n,selection:d,selectionDispatch:u,width:g=600,height:p=650}=e,b=((0,a.F0)(t.recordingObject)||{}).noise_level||1,[h,v]=(0,s.useState)(null),f=(0,s.useMemo)((()=>e=>c().createElement(y,Object.assign({},{sorting:i,curation:n,recording:t,unitId:e,selection:d,selectionDispatch:u},{width:180,height:250,noiseLevel:b,customActions:h||[]}))),[i,t,d,u,b,h]),j=(0,s.useCallback)((()=>{u({type:"ScaleAmpScaleFactor",direction:"up"})}),[u]),E=(0,s.useCallback)((()=>{u({type:"ScaleAmpScaleFactor",direction:"down"})}),[u]);return(0,s.useEffect)((()=>{const e=[{type:"button",callback:j,title:"Scale amplitude up [up arrow]",icon:c().createElement(r.ZTc,null),keyCode:38},{type:"button",callback:E,title:"Scale amplitude down [down arrow]",icon:c().createElement(r.NWQ,null),keyCode:40}];v(e)}),[j,E]),g?c().createElement("div",null,c().createElement(o.Z,{width:g,height:p,initialPosition:36,adjustable:!1},c().createElement(m,{width:36,height:p,customActions:h}),c().createElement(l.Z,{sorting:i,selection:d,curation:n,selectionDispatch:u,unitComponent:f}))):c().createElement("div",null,"No width")};function j(e){e.registerPlugin({type:"SortingView",name:"AverageWaveforms",label:"Average waveforms",priority:50,defaultExpanded:!1,component:f,singleton:!0,icon:c().createElement(n.Z,null)})}},12240:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});var n=i(47033),s=i(56271),c=i.n(s);const r=({job:e,message:t="",width:i=200,height:s=200})=>e?c().createElement(n.Box,{display:"flex",width:i,height:s},c().createElement(n.Box,{m:"auto"},"running"===e.status?c().createElement("span",null,"[",t,"] ",c().createElement(n.CircularProgress,null)):"error"===e.status?c().createElement("span",null,"Error: ",e.error_message," [",t,"]"):"pending"===e.status?c().createElement("span",null,t):c().createElement("span",null,"[",t,"] ",e.status))):c().createElement("div",null,"No job")},45829:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var n=i(47033),s=i(56271),c=i.n(s),r=i(49287),l=i(65405);const o=({sorting:e,selection:t,curation:i,selectionDispatch:o,unitComponent:a})=>{const[d,u]=(0,s.useState)(30),m=(0,l.D)(e.sortingObject,e.recordingObject),g=t.visibleUnitIds;let p=(m?m.unit_ids:[]).filter((e=>!g||g.includes(e))).filter((e=>!t.applyMerges||(0,r.GI)(e,i))),b=!1;p.length>d&&(p=p.slice(0,d),b=!0);const h=(0,s.useCallback)((e=>{const t=Number(e.currentTarget.dataset.unitId);o({type:"UnitClicked",unitId:t,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey})}),[o]);return c().createElement(n.Grid,{container:!0},p.map((e=>{var i;return c().createElement(n.Grid,{key:e,item:!0},c().createElement("div",{className:"plotWrapperStyle"},c().createElement("div",{"data-unit-id":e,className:(null===(i=t.selectedUnitIds)||void 0===i?void 0:i.includes(e))?"plotSelectedStyle":"plotUnselectedStyle",onClick:h},c().createElement("div",{className:"plotUnitLabel"},c().createElement("div",null,"Unit ",e)),a(e))))})),b&&c().createElement("div",{className:"plotWrapperStyle"},c().createElement("div",{className:"plotWrapperStyleButton"},c().createElement(n.Button,{onClick:()=>{u(d+60)}},"Show more units"))))}},65405:(e,t,i)=>{"use strict";i.d(t,{D:()=>c,h:()=>r});var n=i(45185),s=i(56271);const c=(e,t)=>{const{result:i}=(0,n.useHitherJob)(e?"createjob_get_sorting_info":"",{sorting_object:e,recording_object:t},{useClientCache:!0});return i},r=e=>{const t=(0,s.useContext)(n.HitherContext),i=(0,s.useRef)({}),[,c]=(0,s.useState)(0),r={};return e.forEach((e=>{const n=e.sortingId;if(!i.current[n]){const s=t.createHitherJob("createjob_get_sorting_info",{recording_object:e.recordingObject,sorting_object:e.sortingObject},{useClientCache:!0});i.current[n]=s,s.wait().then((()=>{c((e=>e+1))})).catch((()=>{c((e=>e+1))}))}i.current[n].result&&(r[n]=i.current[n].result)})),r}},49287:(e,t,i)=>{"use strict";i.d(t,{kN:()=>a,qG:()=>g,GI:()=>d,CC:()=>o,Zl:()=>r,_S:()=>b,SF:()=>u,fG:()=>v,fB:()=>h,Sd:()=>p,FO:()=>y});var n=i(45185),s=i(56271);const c=(e,t)=>{if(e.min<=t&&t<e.max)return e;const i=e.max-e.min,n=Math.max(0,Math.floor(t-i/2));return{min:n,max:n+i}},r=(e,t)=>{var i,n,s,r;if("SetRecordingSelection"===t.type)return Object.assign({},t.recordingSelection);if("SetSelectedElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{selectedElectrodeIds:t.selectedElectrodeIds.filter((t=>!e.visibleElectrodeIds||e.visibleElectrodeIds.includes(t)))});if("SetVisibleElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{visibleElectrodeIds:t.visibleElectrodeIds,selectedElectrodeIds:e.selectedElectrodeIds?e.selectedElectrodeIds.filter((e=>t.visibleElectrodeIds.includes(e))):void 0});if("SetCurrentTimepoint"===t.type)return Object.assign(Object.assign({},e),{currentTimepoint:t.currentTimepoint||void 0,timeRange:t.ensureInRange&&e.timeRange&&null!==t.currentTimepoint?c(e.timeRange,t.currentTimepoint):e.timeRange});if("SetTimeRange"===t.type)return Object.assign(Object.assign({},e),{timeRange:t.timeRange});if("ZoomTimeRange"===t.type){const s=9e6,c=e.currentTimepoint,r=e.timeRange;if(!r)return e;const o=null!==(i=t.direction)&&void 0!==i?i:"in",a=null!==(n=t.factor)&&void 0!==n?n:1.4,d="out"===o?1/a:a;if((r.max-r.min)/d>s)return e;let u;u=void 0===c||c<r.min?r.min:c>r.max?r.max:c;const m=l(r,d,u);return Object.assign(Object.assign({},e),{timeRange:m})}if("SetAmpScaleFactor"===t.type)return Object.assign(Object.assign({},e),{ampScaleFactor:t.ampScaleFactor});if("ScaleAmpScaleFactor"===t.type){const i=null!==(s=t.direction)&&void 0!==s?s:"up",n=null!==(r=t.multiplier)&&void 0!==r?r:1.4,c="down"===i?1/n:n;return Object.assign(Object.assign({},e),{ampScaleFactor:(e.ampScaleFactor||1)*c})}return"SetCurrentTimepointVelocity"===t.type?Object.assign(Object.assign({},e),{animation:Object.assign(Object.assign({},e.animation||{}),{currentTimepointVelocity:t.velocity})}):"SetWaveformsMode"===t.type?Object.assign(Object.assign({},e),{waveformsMode:t.waveformsMode}):"Set"===t.type?t.state:e},l=(e,t,i)=>{const n=i+(e.min-i)/t,s=i+(e.max-i)/t;return{min:Math.floor(n),max:Math.floor(s)}},o=(e,t)=>((t||{}).mergeGroups||[]).filter((t=>t.includes(e)))[0]||null,a=(e,t,i)=>i&&o(e,t)||e,d=(e,t)=>{const i=o(e,t);return!i||Math.min(...i)===e},u=(e,t)=>"SetSelection"===t.type?t.selection:"SetSelectedUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:t.selectedUnitIds.filter((t=>{var i;return!e.visibleUnitIds||(null===(i=e.visibleUnitIds)||void 0===i?void 0:i.includes(t))}))}):"SetVisibleUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>{var i;return null===(i=t.visibleUnitIds)||void 0===i?void 0:i.includes(e)})):void 0,visibleUnitIds:t.visibleUnitIds}):"UnitClicked"===t.type?((e,t)=>{const i=t.unitId;return t.ctrlKey?(e.selectedUnitIds||[]).includes(i)?Object.assign(Object.assign({},e),{selectedUnitIds:(e.selectedUnitIds||[]).filter((e=>e!==i))}):Object.assign(Object.assign({},e),{selectedUnitIds:[...e.selectedUnitIds||[],i]}):Object.assign(Object.assign({},e),{selectedUnitIds:[i]})})(e,t):"Set"===t.type?t.state:"ToggleApplyMerges"===t.type?m(Object.assign(Object.assign({},e),{applyMerges:!e.applyMerges}),t.curation):r(e,t),m=(e,t)=>e.applyMerges&&t?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>d(e,t))):void 0}):e,g=e=>e.filter((e=>!e.disabled&&!e.development)),p=e=>g(e).filter((e=>"SortingView"===e.type)).map((e=>e)),b=e=>g(e).filter((e=>"RecordingView"===e.type)).map((e=>e)),h=e=>g(e).filter((e=>"SortingUnitView"===e.type)).map((e=>e)),v=e=>g(e).filter((e=>"SortingUnitMetric"===e.type)).map((e=>e)),y=()=>{const e=(0,n.usePlugins)();return(0,s.useMemo)((()=>e.filter((e=>"WorkspaceView"===e.type)).map((e=>e))),[e])}},63847:(e,t,i)=>{"use strict";var n=i(95318),s=i(20862);t.Z=void 0;var c=s(i(56271)),r=(0,n(i(2108)).default)(c.createElement("path",{d:"M10 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12-8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"}),"Grain");t.Z=r}}]);