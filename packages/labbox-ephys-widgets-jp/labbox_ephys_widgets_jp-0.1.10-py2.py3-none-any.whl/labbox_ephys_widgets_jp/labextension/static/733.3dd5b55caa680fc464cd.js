(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[733],{65940:(e,t,r)=>{"use strict";r.d(t,{N:()=>g});var n=r(16213),o=r(17872),i=r(62341);const a={electrodeBoxes:[],radius:0,pixelRadius:0,dragRegion:null,draggedElectrodeIds:[],hoveredElectrodeId:null},s={border:"rgb(30, 30, 30)",base:"rgb(0, 0, 255)",selected:"rgb(196, 196, 128)",hover:"rgb(128, 128, 255)",selectedHover:"rgb(200, 200, 196)",dragged:"rgb(0, 0, 196)",draggedSelected:"rgb(180, 180, 150)",dragRect:"rgba(196, 196, 196, 0.5)",textLight:"rgb(228, 228, 228)",textDark:"rgb(32, 32, 32)"},l=(e,t)=>{if(e.type!==n.II.Release)return;const{selectionDispatch:r,electrodeOpts:i}=t.getProps();if(i.disableSelection)return;const a=t.getState();if(null===a)return;const s=a.electrodeBoxes.filter((t=>(0,o.Xz)(e.point,[t.x,t.y],a.radius))).map((e=>e.id));if(0===s.length)return void(e.modifiers.ctrl||e.modifiers.shift||a.dragRegion||r({type:"SetSelectedElectrodeIds",selectedElectrodeIds:[]}));const l=s[0],c=t.getProps().selection.selectedElectrodeIds||[];r({type:"SetSelectedElectrodeIds",selectedElectrodeIds:e.modifiers.ctrl?c.includes(l)?c.filter((e=>e!==l)):[...c,l]:e.modifiers.shift?[...c,l]:[l]}),t.scheduleRepaint()},c=(e,t)=>{if(e.type!==n.II.Move)return;const r=t.getState();if(null===r)return;const i=r.electrodeBoxes.filter((t=>(0,o.Xz)(e.point,[t.x,t.y],r.radius))).map((e=>e.id));t.setState(Object.assign(Object.assign({},r),{hoveredElectrodeId:0===i.length?null:i[0]})),t.scheduleRepaint()},d=(e,t)=>{var r,n,i;const a=e.getState(),{selectionDispatch:s,electrodeOpts:l}=e.getProps();if(l.disableSelection)return;if(null===a)return;const c=null!==(r=a.electrodeBoxes.filter((e=>(0,o.Qv)(e.rect,t.dragRect))))&&void 0!==r?r:[];t.released?(s({type:"SetSelectedElectrodeIds",selectedElectrodeIds:[...t.shift&&null!==(i=null===(n=e.getProps())||void 0===n?void 0:n.selection.selectedElectrodeIds)&&void 0!==i?i:[],...c.map((e=>e.id))]}),e.setState(Object.assign(Object.assign({},a),{dragRegion:null,draggedElectrodeIds:[]}))):e.setState(Object.assign(Object.assign({},a),{dragRegion:t.dragRect,draggedElectrodeIds:c.map((e=>e.id))})),e.scheduleRepaint()},g=()=>new n.Fw(((e,t,r)=>{var n,o;const i=t.electrodeOpts,a=i.colors||s,l=i.showLabels;e.wipe();const c=r.pixelRadius>5;for(let s of r.electrodeBoxes){const d=!i.disableSelection&&((null===(n=t.selection.selectedElectrodeIds)||void 0===n?void 0:n.includes(s.id))||!1),g=!i.disableSelection&&r.hoveredElectrodeId===s.id,u=!i.disableSelection&&((null===(o=r.draggedElectrodeIds)||void 0===o?void 0:o.includes(s.id))||!1),p=d?u?a.draggedSelected:a.selectedHover:u?a.dragged:g?a.hover:a.base,m=t.layoutMode;if("geom"===m?(e.fillEllipse(s.rect,{color:p}),e.drawEllipse(s.rect,{color:a.border})):"vertical"===m&&e.drawLine(s.rect.xmin,(s.rect.ymin+s.rect.ymax)/2,s.rect.xmax,(s.rect.ymin+s.rect.ymax)/2,{color:a.border}),c){const t=[a.selected,a.draggedSelected,a.hover,a.selectedHover].includes(p)?a.textDark:a.textLight;l&&e.drawText({rect:s.rect,alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:r.pixelRadius,family:"Arial"},pen:{color:t},brush:{color:t},text:s.label})}}r.dragRegion&&e.fillRect(r.dragRegion,{color:a.dragRect})}),((e,t)=>{const r=e.getState(),{width:n,height:o,electrodeLocations:a,electrodeIds:s,layoutMode:l}=t,{electrodeBoxes:c,transform:d,radius:g,pixelRadius:u}=(0,i.Z)({width:n,height:o,electrodeLocations:a,electrodeIds:s,layoutMode:l,maxElectrodePixelRadius:t.electrodeOpts.maxElectrodePixelRadius});e.setTransformMatrix(d),e.setState(Object.assign(Object.assign({},r),{electrodeBoxes:c,radius:g,pixelRadius:u})),e.scheduleRepaint()}),a,{discreteMouseEventHandlers:[l,c],dragHandlers:[d]})},62341:(e,t,r)=>{"use strict";r.d(t,{g:()=>d,Z:()=>g});var n=r(7916),o=r(45157),i=r(17872),a=r(22874);const s=new Map,l=e=>{const t=JSON.stringify(e),r=s.get(t);if(void 0!==r)return r;let o=Number.MAX_VALUE;e.forEach((t=>{e.forEach((e=>{const r=(0,n.norm)([t[0]-e[0],t[1]-e[1]]);0!==r&&(o=Math.min(o,r))}))}));const i=.45*o;return s.set(t,i),i},c=(e,t)=>({xmin:(0,a.Gt)(e.map((e=>e[0])))-t,xmax:(0,a.lR)(e.map((e=>e[0])))+t,ymin:(0,a.Gt)(e.map((e=>e[1])))-t,ymax:(0,a.lR)(e.map((e=>e[1])))+t}),d=e=>{const t=l(e),r=c(e,t);return(0,i.dz)(r)/(0,i.Cr)(r)},g=e=>{const{width:t,height:r,electrodeLocations:n,electrodeIds:s,layoutMode:d}=e;if("vertical"===d)return(({width:e,height:t,electrodeIds:r})=>{const n=r.length,i=(0,o.As)((r=>[10+r[0]*(e-20),10+r[1]*(t-20)]));return{electrodeBoxes:r.map(((e,t)=>{const r=(.5+t)/(n+1),i={xmin:0,xmax:1,ymin:r-.5/(n+1),ymax:r+.5/(n+1)},a=(0,o.As)((e=>[i.xmin+e[0]*(i.xmax-i.xmin),i.ymin+e[1]*(i.ymax-i.ymin)]));return{label:e+"",id:e,x:.5,y:r,rect:i,transform:a}})),transform:i,radius:1/(n+1),pixelRadius:(t-20)/(n+1)}})({width:t,height:r,electrodeIds:s});const g=(e=>{const t=(0,a.Gt)(e.map((e=>e[0]))),r=(0,a.lR)(e.map((e=>e[0]))),n=(0,a.Gt)(e.map((e=>e[1]))),o=(0,a.lR)(e.map((e=>e[1])));return t===r&&n===o?e.map(((e,t)=>[t,0])):e})(n),u=t-20,p=r-20,m=u/p,b=l(g);let h,f=c(g,b),_=(0,i.dz)(f)/(0,i.Cr)(f),E=g;_>1!=m>1&&(E=g.map((e=>[e[1],-e[0]])),f={xmin:f.ymin,xmax:f.ymax,ymin:-f.xmax,ymax:-f.xmin},_=(0,i.dz)(f)/(0,i.Cr)(f)),h=_>m?u/(0,i.dz)(f):p/(0,i.Cr)(f),e.maxElectrodePixelRadius&&b*h>e.maxElectrodePixelRadius&&(h/=b*h/e.maxElectrodePixelRadius);const k=(t-(0,i.dz)(f)*h)/2,y=(r-(0,i.Cr)(f)*h)/2,w=(0,o.As)((e=>[k+(e[0]-f.xmin)*h,y+(e[1]-f.ymin)*h])),x=E.map(((e,t)=>{const r=e[0],n=e[1],a=(0,i.jU)([r,n],b,b),l=(0,o.As)((e=>[a.xmin+e[0]*(a.xmax-a.xmin),a.ymin+e[1]*(a.ymax-a.ymin)]));return{label:s[t]+"",id:s[t],x:r,y:n,rect:a,transform:l}})),R=(0,i.ur)(w,[b,0])[0];return{electrodeBoxes:x,transform:w,radius:b,pixelRadius:R}}},78048:(e,t,r)=>{"use strict";r.d(t,{Z:()=>a});var n=r(47033),o=r(56271),i=r.n(o);const a=e=>i().createElement(n.Accordion,{TransitionProps:{unmountOnExit:void 0===e.unmountOnExit||e.unmountOnExit},defaultExpanded:e.defaultExpanded},i().createElement(n.AccordionSummary,null,e.icon&&i().createElement("span",{style:{paddingRight:10}},e.icon),i().createElement("span",{style:{paddingTop:3}},e.label)),i().createElement(n.AccordionDetails,null,i().createElement("div",{style:{width:"100%"}},e.children)))},96768:(e,t,r)=>{"use strict";r.d(t,{Z:()=>d}),r(39428);var n=r(56271),o=r.n(n),i=r(31675),a=r.n(i),s=r(45679);const l={'code[class*="language-"]':{color:"black",background:"none",fontFamily:"Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace",fontSize:"1em",textAlign:"left",whiteSpace:"pre",wordSpacing:"normal",wordBreak:"normal",wordWrap:"normal",lineHeight:"1.5",MozTabSize:"4",OTabSize:"4",tabSize:"4",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",hyphens:"none",maxHeight:"inherit",height:"inherit",padding:"0 1em",display:"block",overflow:"auto"},'pre[class*="language-"]':{color:"black",background:"none",fontFamily:"Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace",fontSize:"1em",textAlign:"left",whiteSpace:"pre",wordSpacing:"normal",wordBreak:"normal",wordWrap:"normal",lineHeight:"1.5",MozTabSize:"4",OTabSize:"4",tabSize:"4",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",hyphens:"none",position:"relative",margin:".5em 0",overflow:"visible",padding:"0",backgroundColor:"#fdfdfd",WebkitBoxSizing:"border-box",MozBoxSizing:"border-box",boxSizing:"border-box",marginBottom:"1em"},'pre[class*="language-"]>code':{position:"relative",borderLeft:"10px solid #358ccb",boxShadow:"-1px 0px 0px 0px #358ccb, 0px 0px 0px 1px #dfdfdf",backgroundColor:"#fdfdfd",backgroundImage:"linear-gradient(transparent 50%, rgba(69, 142, 209, 0.04) 50%)",backgroundSize:"3em 3em",backgroundOrigin:"content-box",backgroundAttachment:"local"},':not(pre) > code[class*="language-"]':{backgroundColor:"#fdfdfd",WebkitBoxSizing:"border-box",MozBoxSizing:"border-box",boxSizing:"border-box",marginBottom:"1em",position:"relative",padding:".2em",borderRadius:"0.3em",color:"#c92c2c",border:"1px solid rgba(0, 0, 0, 0.1)",display:"inline",whiteSpace:"normal"},'pre[class*="language-"]:before':{content:"''",zIndex:"-2",display:"block",position:"absolute",bottom:"0.75em",left:"0.18em",width:"40%",height:"20%",maxHeight:"13em",boxShadow:"0px 13px 8px #979797",WebkitTransform:"rotate(-2deg)",MozTransform:"rotate(-2deg)",msTransform:"rotate(-2deg)",OTransform:"rotate(-2deg)",transform:"rotate(-2deg)"},'pre[class*="language-"]:after':{content:"''",zIndex:"-2",display:"block",position:"absolute",bottom:"0.75em",left:"auto",width:"40%",height:"20%",maxHeight:"13em",boxShadow:"0px 13px 8px #979797",WebkitTransform:"rotate(2deg)",MozTransform:"rotate(2deg)",msTransform:"rotate(2deg)",OTransform:"rotate(2deg)",transform:"rotate(2deg)",right:"0.75em"},comment:{color:"#7D8B99"},"block-comment":{color:"#7D8B99"},prolog:{color:"#7D8B99"},doctype:{color:"#7D8B99"},cdata:{color:"#7D8B99"},punctuation:{color:"#5F6364"},property:{color:"#c92c2c"},tag:{color:"#c92c2c"},boolean:{color:"#c92c2c"},number:{color:"#c92c2c"},"function-name":{color:"#c92c2c"},constant:{color:"#c92c2c"},symbol:{color:"#c92c2c"},deleted:{color:"#c92c2c"},selector:{color:"#2f9c0a"},"attr-name":{color:"#2f9c0a"},string:{color:"#2f9c0a"},char:{color:"#2f9c0a"},function:{color:"#2f9c0a"},builtin:{color:"#2f9c0a"},inserted:{color:"#2f9c0a"},operator:{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)"},entity:{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)",cursor:"help"},url:{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)"},variable:{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)"},atrule:{color:"#1990b8"},"attr-value":{color:"#1990b8"},keyword:{color:"#1990b8"},"class-name":{color:"#1990b8"},regex:{color:"#e90"},important:{color:"#e90",fontWeight:"normal"},".language-css .token.string":{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)"},".style .token.string":{color:"#a67f59",background:"rgba(255, 255, 255, 0.5)"},bold:{fontWeight:"bold"},italic:{fontStyle:"italic"},namespace:{Opacity:".7"},'pre[class*="language-"].line-numbers.line-numbers':{paddingLeft:"0"},'pre[class*="language-"].line-numbers.line-numbers code':{paddingLeft:"3.8em"},'pre[class*="language-"].line-numbers.line-numbers .line-numbers-rows':{left:"0"},'pre[class*="language-"][data-line]':{paddingTop:"0",paddingBottom:"0",paddingLeft:"0"},"pre[data-line] code":{position:"relative",paddingLeft:"4em"},"pre .line-highlight":{marginTop:"0"}},c=({value:e,language:t})=>o().createElement(s.Prism,{language:t,style:l},e),d=({source:e,substitute:t})=>{const r=t?((e,t)=>{let r=e;for(let e in t)r=r.split(`{${e}}`).join(t[e]||"");return r})(e,t):e;return o().createElement("div",{className:"markdown-body"},o().createElement(a(),{source:r,renderers:{code:c}}))}},88493:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});var n=r(56271),o=r.n(n),i=r(13090),a=r.n(i);const s=e=>{var t,r,i;const{width:s,height:l,initialPosition:c,onChange:d,adjustable:g=!0,positionFromRight:u=!1}=e,[p,m]=(0,n.useState)(c);if(!e.children)throw Error("Unexpected: no props.children");let b,h;if(Array.isArray(e.children)){const t=e.children.filter((e=>void 0!==e));b=t[0],h=t[1]||null}else b=e.children,h=null;if(!h)return o().createElement(b.type,Object.assign({},b.props,{width:s,height:l}));const f=u?s-p:p,_=g?null!==(t=e.gripThickness)&&void 0!==t?t:10:0,E=g?null!==(r=e.gripInnerThickness)&&void 0!==r?r:4:0,k=g?null!==(i=e.gripMargin)&&void 0!==i?i:2:0,y=f-_/2-k,w=s-y-_-2*k;let x={top:0,left:0,width:s,height:l},R={left:0,top:0,width:y,height:l,zIndex:0,overflowY:"auto",overflowX:"hidden"},I={left:y+_+2*k,top:0,width:w,height:l,zIndex:0,overflowY:"auto",overflowX:"hidden"},S={left:0,top:0,width:_+2*k,height:l,backgroundColor:"transparent",cursor:"col-resize",zIndex:9998},v={left:k,top:0,width:_,height:l,background:"rgb(230, 230, 230)",cursor:"col-resize"},C={top:0,left:(_-E)/2,width:E,height:l,background:"gray",cursor:"col-resize"};return o().createElement("div",{className:"splitter",style:Object.assign(Object.assign({},x),{position:"relative"})},o().createElement("div",{key:"child1",style:Object.assign(Object.assign({},R),{position:"absolute"}),className:"SplitterChild"},o().createElement(b.type,Object.assign({},b.props,{width:y,height:l}))),g&&o().createElement(a(),{key:"drag",position:{x:f-_/2-k,y:0},axis:"x",onDrag:(e,t)=>{},onStop:(e,t)=>((e,t)=>{const r=t.x;if(r===f)return;const n=u?s-r:r;m(n),d&&d(n)})(0,t)},o().createElement("div",{style:Object.assign(Object.assign({},S),{position:"absolute"})},o().createElement("div",{style:Object.assign(Object.assign({},v),{position:"absolute"})},o().createElement("div",{style:Object.assign(Object.assign({},C),{position:"absolute"})})))),o().createElement("div",{key:"child2",style:Object.assign(Object.assign({},I),{position:"absolute"}),className:"SplitterChild"},o().createElement(h.type,Object.assign({},h.props,{width:w,height:l}))))}},85155:(e,t,r)=>{"use strict";r.d(t,{F0:()=>i,ZL:()=>a});var n=r(45185),o=r(56271);const i=e=>{const{result:t}=(0,n.useHitherJob)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},a=e=>{const t=(0,o.useContext)(n.HitherContext),r=(0,o.useRef)({}),[,i]=(0,o.useState)(0),a={};return e.forEach((e=>{const n=e.recordingId;if(!r.current[n]){const o=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});r.current[n]=o,o.wait().then((()=>{i((e=>e+1))})).catch((()=>{i((e=>e+1))}))}r.current[n].result&&(a[n]=r.current[n].result)})),a}},65405:(e,t,r)=>{"use strict";r.d(t,{D:()=>i,h:()=>a});var n=r(45185),o=r(56271);const i=(e,t)=>{const{result:r}=(0,n.useHitherJob)(e?"createjob_get_sorting_info":"",{sorting_object:e,recording_object:t},{useClientCache:!0});return r},a=e=>{const t=(0,o.useContext)(n.HitherContext),r=(0,o.useRef)({}),[,i]=(0,o.useState)(0),a={};return e.forEach((e=>{const n=e.sortingId;if(!r.current[n]){const o=t.createHitherJob("createjob_get_sorting_info",{recording_object:e.recordingObject,sorting_object:e.sortingObject},{useClientCache:!0});r.current[n]=o,o.wait().then((()=>{i((e=>e+1))})).catch((()=>{i((e=>e+1))}))}r.current[n].result&&(a[n]=r.current[n].result)})),a}},21677:(e,t,r)=>{"use strict";r.d(t,{Z:()=>l});var n=r(56271),o=r.n(n),i=r(65940),a=r(45157),s=r(16213);const l=e=>{const t=(0,n.useMemo)((()=>({layoutMode:"geom",electrodeIds:e.electrodes.map((e=>e.id)),electrodeLocations:e.electrodes.map((e=>[e.x,e.y])),width:e.width,height:e.height,selection:e.selection,selectionDispatch:e.selectionDispatch,electrodeOpts:{showLabels:!0,maxElectrodePixelRadius:25},noiseLevel:0,samplingFrequency:0})),[e]),r=(0,s.sJ)(i.N,t),l=(0,s.jU)([r]);return o().createElement(a.ZP,Object.assign({key:"electrodeGeometryCanvas",layers:l},{width:e.width,height:e.height}))}},45:(e,t,r)=>{"use strict";r.d(t,{j:()=>n,Z:()=>s});const n=(e,t)=>{if("SET_CURATION"===t.type)return t.curation;if("ADD_UNIT_LABEL"===t.type){const r=t.unitId+"",n=(e.labelsByUnit||{})[r]||[];return n.includes(t.label)?e:Object.assign(Object.assign({},e),{labelsByUnit:Object.assign(Object.assign({},e.labelsByUnit),{[r]:[...n,t.label].sort()})})}if("REMOVE_UNIT_LABEL"===t.type){const r=t.unitId+"",n=(e.labelsByUnit||{})[r]||[];return n.includes(t.label)?Object.assign(Object.assign({},e),{labelsByUnit:Object.assign(Object.assign({},e.labelsByUnit),{[r]:n.filter((e=>e!==t.label))})}):e}return"MERGE_UNITS"===t.type?Object.assign(Object.assign({},e),{mergeGroups:a([...e.mergeGroups||[],t.unitIds])}):"UNMERGE_UNITS"===t.type?Object.assign(Object.assign({},e),{mergeGroups:a((e.mergeGroups||[]).map((e=>e.filter((e=>!t.unitIds.includes(e))))))}):e},o=(e,t)=>e.filter((e=>t.includes(e))),i=(e,t)=>[...e,...t.filter((t=>!e.includes(t)))].sort(),a=e=>{const t=e.map((e=>[...e]));let r=!0;for(;r;){r=!1;for(let e=0;e<t.length;e++){const n=t[e];for(let a=e+1;a<t.length;a++){const s=t[a];o(n,s).length>0&&(t[e]=i(n,s),t[a]=[],r=!0)}}}return t.filter((e=>e.length>=2))},s=(e,t)=>{switch(t.type){case"ADD_RECORDING":return Object.assign(Object.assign({},e),{recordings:[...e.recordings.filter((e=>e.recordingId!==t.recording.recordingId)),t.recording]});case"DELETE_RECORDINGS":return Object.assign(Object.assign({},e),{recordings:e.recordings.filter((e=>!t.recordingIds.includes(e.recordingId)))});case"ADD_SORTING":return Object.assign(Object.assign({},e),{sortings:[...e.sortings.filter((e=>e.sortingId!==t.sorting.sortingId)),t.sorting]});case"DELETE_SORTINGS":return Object.assign(Object.assign({},e),{sortings:e.sortings.filter((e=>!t.sortingIds.includes(e.sortingId)))});case"DELETE_SORTINGS_FOR_RECORDINGS":return Object.assign(Object.assign({},e),{sortings:e.sortings.filter((e=>!t.recordingIds.includes(e.recordingId)))});case"SET_UNIT_METRICS_FOR_SORTING":return Object.assign(Object.assign({},e),{sortings:e.sortings.map((e=>e.sortingId===t.unitMetricsForSorting.sortingId?Object.assign(Object.assign({},e),{unitMetricsUri:t.unitMetricsForSorting.metricsUri}):e))});default:return e}}},80733:(e,t,r)=>{"use strict";r.r(t),r.d(t,{activate:()=>q});var n=r(56271),o=r.n(n),i=r(45185),a=r(31222),s=r(85155),l=r(65405),c=r(49287),d=r(5597),g=r(45);const u=(0,i.createCalculationPool)({maxSimultaneous:6}),p=e=>{(0,n.useContext)(i.HitherContext);const{workspaceRoute:t,readOnly:r,sorting:p,recording:m,workspaceRouteDispatch:b}=e,[h,f]=(0,n.useReducer)(c.SF,{}),_=(0,l.D)(p?p.sortingObject:null,p?p.recordingObject:null),E=(0,s.F0)(m.recordingObject),k=p?p.sortingId:null,{feedUri:y,workspaceName:w}=(0,d.x)(t.workspaceUri),[x,R]=(0,n.useReducer)(g.j,(0,n.useMemo)((()=>({})),[])),I=(0,n.useCallback)((e=>{e.forEach((e=>R(e)))}),[]),S=(0,n.useMemo)((()=>({name:"sortingCuration",workspaceName:w,sortingId:k})),[w,k]),{appendMessages:v}=(0,i.useSubfeed)({feedUri:y,subfeedName:S,onMessages:I}),C=(0,n.useCallback)((e=>{v([e])}),[v]);(0,n.useEffect)((()=>{!h.timeRange&&E&&f({type:"SetTimeRange",timeRange:{min:0,max:Math.min(E.num_frames,E.sampling_frequency/10)}})}),[h,E]);const O=e.width||800,j=e.height||800,T=(0,n.useMemo)((()=>({position:"absolute",left:0,top:j-20,width:O,height:20,overflow:"hidden"})),[O,j,20]),D=O,L=j-20,M=(0,n.useMemo)((()=>({position:"absolute",left:0,top:0,width:D,height:L})),[D,L]),U=(0,i.usePlugins)(),z=(0,c.Sd)(U).filter((e=>"MVSortingView"===e.name))[0];if(!z)throw Error("Missing sorting view: MVSortingView");const P=(0,n.useMemo)((()=>z.props||{}),[z.props]),N=(0,n.useCallback)((()=>{b({type:"gotoRecordingPage",recordingId:m.recordingId})}),[b,m.recordingId]),B=(0,n.useMemo)((()=>({sortingId:"",sortingLabel:"",sortingPath:"",sortingObject:null,recordingId:"",recordingPath:"",recordingObject:null})),[]),A=(0,n.useMemo)((()=>({unit_ids:[],samplerate:0})),[]);return!m&&p?o().createElement("h3",null,`Recording not found: ${p.recordingId}`):E?!_&&p?o().createElement("h3",null,"Loading sorting info..."):o().createElement("div",null,o().createElement("div",{style:M},o().createElement(z.component,Object.assign({},P,{sorting:p||B,recording:m,sortingInfo:_||A,recordingInfo:E,selection:h,selectionDispatch:f,curation:x,curationDispatch:C,readOnly:r,calculationPool:u,width:D,height:L}))),o().createElement("div",{style:T},p?o().createElement("span",null,"Sorting: ",p.sortingLabel," | Recording: ",o().createElement(a.Z,{onClick:N},m.recordingLabel)):o().createElement("span",null,"Recording: ",o().createElement(a.Z,{onClick:N},m.recordingLabel)))):o().createElement("h3",null,"Loading recording info...")};var m=r(47033),b=r(88493),h=r(78048),f=r(96768);const _="import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n# adjust these values\nworkspace_uri = '{workspaceUri}'\nrecording_label = 'simulated_recording'\nduration_sec = 50 # duration of simulated recording\nnum_channels = 8 # num. channels in simulated recording\nnum_units = 5 # num units\nseed = 1 # random number generator seed\n\ndef prepare_recording_sorting():\n    # Simulate a recording (toy example)\n    recording, sorting = se.example_datasets.toy_example(duration=duration_sec, num_channels=num_channels, K=num_units, seed=seed)\n    R = le.LabboxEphysRecordingExtractor.from_memory(recording, serialize=True, serialize_dtype=np.int16)\n    S = le.LabboxEphysSortingExtractor.from_memory(sorting, serialize=True)\n    return R, S\n\nrecording, sorting_true = prepare_recording_sorting()\nsorting_label = 'true'\nworkspace = le.load_workspace(workspace_uri)\nprint(f'Workspace URI: {workspace.get_uri()}')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting_true, recording_id=R_id, label=sorting_label)",E="import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n\n# Adjust these values\nrecording_label = 'despy_tet3'\nsorting_label = 'sorting'\nrecording_nwb_path = '<path or URI of nwb recording>'\nsorting_nwb_path = '<path or URI of nwb sorting>'\nworkspace_uri = '{workspaceUri}'\n\nrecording_uri = kp.store_object({\n    'recording_format': 'nwb',\n    'data': {\n        'path': recording_nwb_path\n    }\n})\nsorting_uri = kp.store_object({\n    'sorting_format': 'nwb',\n    'data': {\n        'path': sorting_nwb_path\n    }\n})\n\nsorting = le.LabboxEphysSortingExtractor(sorting_uri, samplerate=30000)\nrecording = le.LabboxEphysRecordingExtractor(recording_uri, download=True)\n\nworkspace = le.load_workspace(workspace_uri)\nprint(f'Workspace URI: {workspace.get_uri()}')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting, recording_id=R_id, label=sorting_label)",k='import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n# Here are some examples to select from\nX1 = {\n    "label": "SF/synth_magland_noise10_K10_C4/001_synth",\n    "recording_uri": "sha1://f060669aadaa0f8ebe296bf72895df3899f8cf45/SF/synth_magland_noise10_K10_C4/001_synth.json",\n    "sorting_true_uri": "sha1://5b07e41bf62c045a549242c0caa866d272a33ab8/firings_true.mda"\n}\nX2 = {\n    "label": "SF/PAIRED_BOYDEN/paired_boyden32c/419_1_7",\n    "recording_uri": "sha1://759c81e6e20d3c352eaff6ce5d4dc7f948c45f25/SF/PAIRED_BOYDEN/paired_boyden32c/419_1_7.json",\n    "sorting_true_uri": "sha1://a5b7de64d7a2a96c0e1af70cdb2d4ae927e4949d/firings_true.mda"\n}\nX3 = {\n    "label": "SF/PAIRED_KAMPFF/paired_kampff/2014_11_25_Pair_3_0",\n    "recording_uri": "sha1://a205f87cef8b7f86df7a09cddbc79a1fbe5df60f/SF/PAIRED_KAMPFF/paired_kampff/2014_11_25_Pair_3_0.json",\n    "sorting_true_uri": "sha1://1cd517687aeca7ecdfaa9695680038d142a75031/firings_true.mda"\n}\n# To find more examples, see: https://github.com/flatironinstitute/spikeforest_recordings\n# However: note that some processing needs to be done to the files in this repo (to add the manifests to the raw data). This is WIP\n\n# Adjust these values ###########################\nX = X1 # Select example from above\nworkspace_uri = \'{workspaceUri}\'\n#################################################\n\nrecording_label = X[\'label\']\nrecording_uri = X[\'recording_uri\']\nsorting_true_uri = X[\'sorting_true_uri\']\nrecording = le.LabboxEphysRecordingExtractor(recording_uri, download=True)\nsorting_true = le.LabboxEphysSortingExtractor(sorting_true_uri, samplerate=30000)\n\nsorting_label = \'true\'\nworkspace = le.load_workspace(workspace_uri)\nprint(f\'Workspace URI: {workspace.get_uri()}\')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting_true, recording_id=R_id, label=sorting_label)',y=e=>"```python\n"+e+"\n```",w=({text:e})=>{const[t,r]=(0,n.useState)(!1),i=(0,n.useCallback)((()=>{window.isSecureContext?(navigator.clipboard.writeText(e),r(!0),setTimeout((()=>{r(!1)}),3e3)):window.alert("Unable to copy to clipbard (not a secure context). This is probably because this site uses http rather than https.")}),[e]);return o().createElement("button",{onClick:i},t?"Copied":"Copy to clipboard")},x=({workspaceRoute:e})=>{const t=t=>((e,t)=>{let r=e;for(let e in t)r=r.split(`{${e}}`).join(t[e]||"");return r})(t,{workspaceUri:e.workspaceUri});return o().createElement("div",null,o().createElement(f.Z,{source:"## Importing recordings\n\nTo import a recording into labbox-ephys, you can run a Python script on the computer where labbox-ephys is installed, or from a kachery node that has the appropriate access. See the example scripts below."}),o().createElement(h.Z,{label:"Import example simulated recording"},o().createElement(w,{text:t(_)}),o().createElement(f.Z,{source:y(t(_))})),o().createElement(h.Z,{label:"Import SpikeForest recordings"},o().createElement(w,{text:t(k)}),o().createElement(f.Z,{source:y(t(k))})),o().createElement(h.Z,{label:"Import NWB recordings"},o().createElement(w,{text:t(E)}),o().createElement(f.Z,{source:y(t(E))})))};var R=r(62330),I=r(93379),S=r.n(I),v=r(436);S()(v.Z,{insert:"head",singleton:!1}),v.Z.locals;const C=e=>o().createElement("span",null,e.map((e=>{return t=e,o().createElement("span",{key:t.sortingId},t.sortingId," (","",")");var t}))),O=({recording:e,onClick:t})=>{const r=(0,n.useCallback)((()=>{t(e)}),[e,t]);return o().createElement(j,{title:"View recording",onClick:r},e.recordingLabel)},j=({title:e,children:t,onClick:r})=>o().createElement("button",{type:"button",className:"link-button",onClick:r},t),T=({recordings:e,sortings:t,onDeleteRecordings:r,readOnly:i,workspaceRouteDispatch:a})=>{const l=(0,n.useMemo)((()=>{const r={};return e.forEach((e=>{r[e.recordingId]=t.filter((t=>t.recordingId===e.recordingId))})),r}),[e,t]);var c;c="recordingLabel",e=e.sort((function(e,t){var r=e[c],n=t[c];return r<n?-1:r>n?1:0}));const d=(0,n.useCallback)((e=>{a({type:"gotoRecordingPage",recordingId:e.recordingId})}),[a]),g=(0,s.ZL)(e),u=(0,n.useMemo)((()=>e.map((e=>{const t=g[e.recordingId];return{key:e.recordingId,columnValues:{recording:e,recordingLabel:{text:e.recordingLabel,element:o().createElement(O,{onClick:d,recording:e})},numChannels:t?t.channel_ids.length:{element:o().createElement(m.CircularProgress,null)},samplingFrequency:t?t.sampling_frequency:"",durationMinutes:t?t.num_frames/t.sampling_frequency/60:"",sortings:{element:C(l[e.recordingId])}}}}))),[e,l,d,g]),p=(0,n.useCallback)((e=>{r&&r([e])}),[r]);return o().createElement("div",null,o().createElement(R.Z,{rows:u,columns:[{key:"recordingLabel",label:"Recording"},{key:"numChannels",label:"Num. channels"},{key:"samplingFrequency",label:"Samp. freq. (Hz)"},{key:"durationMinutes",label:"Duration (min)"},{key:"sortings",label:"Sortings"}],deleteRowLabel:"Remove this recording",onDeleteRow:i?void 0:p}))},D=({width:e,height:t,sortings:r,recordings:i,onDeleteRecordings:a,workspaceRoute:s,workspaceRouteDispatch:l})=>{const[c,d]=(0,n.useState)(!1),g=(0,n.useCallback)((()=>{d(!0)}),[]);return o().createElement(b.Z,Object.assign({},{width:e,height:t},{initialPosition:300,positionFromRight:!0}),o().createElement("div",null,!c&&o().createElement("div",null,o().createElement(m.Button,{onClick:g},"Import recordings")),o().createElement(T,Object.assign({},{sortings:r,recordings:i,onDeleteRecordings:a,readOnly:!1,workspaceRouteDispatch:l}))),c&&o().createElement(x,{workspaceRoute:s}))};var L=r(21677);const M=({sampling_frequency:e,channel_ids:t,channel_groups:r,num_frames:n,noise_level:i})=>o().createElement(m.Table,{className:"NiceTable"},o().createElement(m.TableHead,null),o().createElement(m.TableBody,null,o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Sampling frequency"),o().createElement(m.TableCell,null,e)),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Num. frames"),o().createElement(m.TableCell,null,n)),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Duration (min)"),o().createElement(m.TableCell,null,n/e/60)),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Num. channels"),o().createElement(m.TableCell,null,t.length)),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Channel IDs"),o().createElement(m.TableCell,null,t.length<20?U(t):U(t.slice(0,20))+" ...")),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Channel groups"),o().createElement(m.TableCell,null,r.length<20?U(r):U(r.slice(0,20))+" ...")),o().createElement(m.TableRow,null,o().createElement(m.TableCell,null,"Noise level"),o().createElement(m.TableCell,null,i))));function U(e){return e.map((e=>e+"")).join(", ")}const z=({recordingInfo:e,hideElectrodeGeometry:t})=>{const r=e,i=(0,n.useMemo)((()=>r?((e,t)=>{if(e&&t&&t.length!==e.length)throw Error("Electrode ID count does not match location count.");return t.map(((t,r)=>{const n=e[r];return{label:t+"",x:n[0],y:n[1],id:t}}))})(r.geom,r.channel_ids):[]),[r]),[a,s]=(0,n.useReducer)(c.Zl,{});return r?o().createElement(o().Fragment,null,o().createElement("div",{style:{width:600}},o().createElement(M,{sampling_frequency:r.sampling_frequency,num_frames:r.num_frames,channel_ids:r.channel_ids,channel_groups:r.channel_groups,noise_level:r.noise_level})),!t&&o().createElement(L.Z,{electrodes:i,selection:a,selectionDispatch:s,width:350,height:150})):o().createElement("div",null,"No recording info found for recording.")},P="# Prerequisites:\n#    SpikeInterface/spikesorters: `pip install spikesorters`\n#    SpyKING CIRCUS: `pip install spyking-circus`\n#    On Ubuntu, the following are required for spyking circus:\n#        pip install pyqt5\n#        apt install qt5-default\n#    For more information: https://spyking-circus.readthedocs.io/en/latest/introduction/install.html\n\nimport spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nfrom labbox_ephys import sorters\nimport kachery_p2p as kp\n\nif __name__ == '__main__':\n    # adjust these values\n    workspace_uri = '{workspaceUri}'\n    recording_id = '{recordingId}' # {recordingLabel}\n\n    workspace = le.load_workspace(workspace_uri)\n    le_recording = workspace.get_recording(recording_id)\n    recording_object = le_recording['recordingObject']\n\n    sorting_object = sorters.spykingcircus(\n        recording_object=recording_object,\n        detect_sign=-1,\n        adjacency_radius=100,\n        detect_threshold=6,\n        template_width_ms=3,\n        filter=True,\n        merge_spikes=True,\n        auto_merge=0.75,\n        num_workers=None,\n        whitening_max_elts=1000,\n        clustering_max_elts=10000\n    )\n    sorting = le.LabboxEphysSortingExtractor(sorting_object)\n\n    S_id = workspace.add_sorting(\n        sorting=sorting,\n        recording_id=recording_id,\n        label='spykingcircus'\n    )",N=({text:e})=>{const[t,r]=(0,n.useState)(!1),i=(0,n.useCallback)((()=>{window.isSecureContext?(navigator.clipboard.writeText(e),r(!0),setTimeout((()=>{r(!1)}),3e3)):window.alert("Unable to copy to clipbard (not a secure context). This is probably because this site uses http rather than https.")}),[e]);return o().createElement("button",{onClick:i},t?"Copied":"Copy to clipboard")},B=({workspaceRoute:e,recordingId:t,recordingLabel:r})=>{const n=n=>((e,t)=>{let r=e;for(let e in t)r=r.split(`{${e}}`).join(t[e]||"");return r})(n,{workspaceUri:e.workspaceUri,recordingId:t,recordingLabel:r});return o().createElement("div",null,o().createElement(f.Z,{source:"## Spike sorting\n\nUse one of the following scripts to run spike sorting and import the result into this workspace. You must\nrun the script on the computer where labbox-ephys is installed, or from a kachery node that has the appropriate access."}),o().createElement(h.Z,{label:"SpyKING CIRCUS"},o().createElement(N,{text:n(P)}),o().createElement(f.Z,{source:(i=n(P),"```python\n"+i+"\n```")})));var i},A=({sorting:e,onClick:t})=>{const r=(0,n.useCallback)((()=>{t(e)}),[e,t]);return o().createElement(Z,{title:"View recording",onClick:r},e.sortingLabel)},Z=({title:e,children:t,onClick:r})=>o().createElement("button",{type:"button",className:"link-button",onClick:r},t),F=({sortings:e,onDeleteSortings:t,readOnly:r,workspaceRouteDispatch:i})=>{const a=(0,n.useCallback)((e=>{i({type:"gotoSortingPage",recordingId:e.recordingId,sortingId:e.sortingId})}),[i]),s=(0,l.h)(e),c=(0,n.useMemo)((()=>{return t="sortingLabel",e.sort((function(e,r){var n=e[t],o=r[t];return n<o?-1:n>o?1:0}));var t}),[e]),d=(0,n.useMemo)((()=>c.map((e=>{const t=s[e.sortingId];return{key:e.sortingId,columnValues:{sorting:e,sortingLabel:{text:e.sortingLabel,element:o().createElement(A,{sorting:e,onClick:a})},numUnits:t?t.unit_ids.length:{element:o().createElement(m.CircularProgress,null)}}}}))),[c,a,s]),g=(0,n.useCallback)((e=>{t&&t([e])}),[t]);return o().createElement("div",null,o().createElement(R.Z,{rows:d,columns:[{key:"sortingLabel",label:"Sorting"},{key:"numUnits",label:"Num. units"}],deleteRowLabel:"Remove this sorting",onDeleteRow:r?void 0:g}))},G=({sortings:e,workspaceRouteDispatch:t,workspaceRoute:r,onDeleteSortings:n})=>o().createElement(m.Paper,null,o().createElement("h3",null,`${e.length} sorting${1!==e.length?"s":""}`),o().createElement(F,{sortings:e,workspaceRouteDispatch:t,readOnly:!1,onDeleteSortings:n})),H=((0,i.createCalculationPool)({maxSimultaneous:6}),({recording:e,sortings:t,workspaceRoute:r,workspaceRouteDispatch:l,onDeleteSortings:d,width:g,height:u})=>{const p=(0,s.F0)(e.recordingObject),[h,f]=(0,n.useState)(!1),[_,E]=(0,n.useReducer)(c.Zl,{});(0,n.useEffect)((()=>{!_.timeRange&&p&&E({type:"SetTimeRange",timeRange:{min:0,max:Math.min(p.num_frames,p.sampling_frequency/10)}})}),[_,p]);const k=(0,n.useCallback)((()=>{l({type:"gotoRecordingsPage"})}),[l]),y=(0,n.useCallback)((()=>{l({type:"gotoSortingPage",recordingId:e.recordingId,sortingId:"-"})}),[l]),w=(0,i.usePlugins)();if((0,n.useMemo)((()=>(0,c._S)(w)),[w]),!p)return o().createElement("div",null,"Loading recording info");const x=o().createElement("div",{style:{margin:20}},o().createElement(m.Grid,{container:!0,spacing:3},o().createElement(m.Grid,{item:!0,xs:12,xl:6},o().createElement(m.Button,{onClick:k},"Back to recordings"),o().createElement("h2",null,e.recordingLabel),o().createElement("div",null,e.recordingPath),o().createElement(z,{recordingInfo:p,hideElectrodeGeometry:!0})),o().createElement(m.Grid,{item:!0,xs:12,xl:6},o().createElement(a.Z,{onClick:y},"Explore recording")),o().createElement(m.Grid,{item:!0,xs:12,xl:6},o().createElement(G,{sortings:t,workspaceRouteDispatch:l,workspaceRoute:r,onDeleteSortings:d}))));return o().createElement(b.Z,Object.assign({},{width:g,height:u},{initialPosition:300,positionFromRight:!0}),o().createElement("div",null,!h&&o().createElement("div",null,o().createElement(m.Button,{onClick:()=>{f(!0)}},"Spike sorting")),x),h&&o().createElement(B,{workspaceRoute:r,recordingId:e.recordingId,recordingLabel:e.recordingLabel}))}),W=({workspace:e,workspaceDispatch:t,workspaceRoute:r,workspaceRouteDispatch:i,width:a=500,height:s=500})=>{const l=(0,n.useCallback)((e=>{t({type:"DELETE_RECORDINGS",recordingIds:e})}),[t]),c=(0,n.useCallback)((e=>{t({type:"DELETE_SORTINGS",sortingIds:e})}),[t]);switch(r.page){case"recordings":return o().createElement(D,Object.assign({onDeleteRecordings:l},{width:a,height:s,recordings:e.recordings,sortings:e.sortings,workspaceRoute:r,workspaceRouteDispatch:i}));case"recording":{const t=r.recordingId,n=e.recordings.filter((e=>e.recordingId===t))[0];return n?o().createElement(H,Object.assign({onDeleteSortings:c},{width:a,height:s,recording:n,workspaceRouteDispatch:i,workspaceRoute:r},{sortings:e.sortings.filter((e=>e.recordingId===t))})):o().createElement("div",null,"Recording not found: ",t)}case"sorting":{const t=r.recordingId,n=e.recordings.filter((e=>e.recordingId===t))[0];if(!n)return o().createElement("div",null,"Recording not found: ",t);const l=r.sortingId;if("-"!==l){const c=e.sortings.filter((e=>e.recordingId===t&&e.sortingId===l))[0];return c?o().createElement(p,{sorting:c,recording:n,width:a,height:s,readOnly:!1,workspaceRoute:r,workspaceRouteDispatch:i}):o().createElement("div",null,"Sorting not found: ",t,"/",l)}return o().createElement(p,{sorting:null,recording:n,width:a,height:s,readOnly:!1,workspaceRoute:r,workspaceRouteDispatch:i})}}};function q(e){e.registerPlugin({type:"WorkspaceView",name:"WorkspaceView",label:"Workspace View",component:W})}},436:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});var n=r(23645),o=r.n(n)()((function(e){return e[1]}));o.push([e.id,".link-button {\n  background-color: transparent;\n  border: none;\n  cursor: pointer;\n  text-decoration: underline;\n  display: inline;\n  margin: 0;\n  padding: 0;\n}\n\n.link-button:hover,\n.link-button:focus {\ntext-decoration: none;\n}",""]);const i=o}}]);