(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[9101],{96333:(e,t,n)=>{"use strict";n.d(t,{Z:()=>f});var r=n(45185),o=n(56271),l=n.n(o),a=n(49287),i=n(36464),c=n(93379),s=n.n(c),u=n(97948);s()(u.Z,{insert:"head",singleton:!1}),u.Z.locals;var m=n(48003),d=n(9756),p=n(47033);const g=e=>{const{columns:t,onColumnClick:n,primarySortColumnDirection:r,primarySortColumnName:o,onDeselectAll:a}=e;return l().createElement(p.TableHead,null,l().createElement(p.TableRow,null,a?l().createElement(p.TableCell,{key:"_checkbox"},l().createElement(h,{rowId:"",selected:!1,onClick:()=>{a()},isDeselectAll:!0})):l().createElement(p.TableCell,{key:"_checkbox"}),t.map((e=>{const t=(e.tooltip||e.label||"")+" (click to sort)";return l().createElement(p.TableCell,{key:e.columnName,onClick:()=>n(e),title:t,style:{cursor:"pointer"}},l().createElement(p.Grid,{container:!0,justify:"flex-start",style:{flexFlow:"row"}},l().createElement(p.Grid,{item:!0,key:"icon"},l().createElement("span",{style:{fontSize:16,color:"gray",paddingLeft:3,paddingRight:5,paddingTop:2}},o===e.columnName&&("ascending"===r?l().createElement(d.FontAwesomeIcon,{icon:m.faCaretUp}):l().createElement(d.FontAwesomeIcon,{icon:m.faCaretDown})))),l().createElement(p.Grid,{item:!0,key:"text"},l().createElement("span",null,l().createElement("span",{key:"label"},e.label),l().createElement("span",{key:"progress"},e.calculating&&l().createElement(p.LinearProgress,null))))))}))))},h=l().memo((e=>{const{rowId:t,selected:n,onClick:r,isDeselectAll:o}=e;return l().createElement(p.Checkbox,{checked:n,indeterminate:!!o,onClick:()=>r(t),style:{padding:1},title:o?"Deselect all":`Select ${t}`})})),b=e=>{const{selectedRowIds:t,onSelectedRowIdsChanged:n,rows:r,columns:a,defaultSortColumnName:i,height:c}=e,[s,u]=(0,o.useState)([]);(0,o.useEffect)((()=>{0===s.length&&i&&u([i])}),[u,s,i]);const m=(0,o.useCallback)((e=>{const r=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(r)}),[t,n]),d=[...r],b=e=>a.filter((t=>t.columnName===e))[0],f=(e=>{const t=[];for(let n=0;n<e.length;n++){const r=e[n-1]!==e[n];t.push({columnName:e[n],keyOrder:n,sortAscending:r})}return t})(s);for(const e of f){const t=e.columnName,n=b(t);d.sort(((r,o)=>{const l=r.data[t]||{},a=o.data[t]||{},i=l.sortValue,c=a.sortValue;return e.sortAscending?n.sort(i,c):n.sort(c,i)}))}const y=(t||[]).reduce(((e,t)=>(e[t]=!0,e)),{}),v=f.length>0?f[f.length-1]:void 0,E=v?v.columnName:void 0,_=v?v.sortAscending?"ascending":"descending":void 0;return l().createElement(p.TableContainer,{style:void 0!==c?{maxHeight:c}:{}},l().createElement(p.Table,{stickyHeader:!0,className:"TableWidget"},l().createElement(g,{columns:a,primarySortColumnName:E,primarySortColumnDirection:_,onColumnClick:e=>{const t=e.columnName;let n=[...s];n=s[s.length-1]===t?s[s.length-2]===t?n.slice(0,n.length-1):[...n,t]:[...n.filter((e=>e!==t)),t],u(n)},onDeselectAll:t.length>0?()=>{n([])}:void 0}),l().createElement(p.TableBody,null,d.map((e=>{const t=y[e.rowId]||!1;return l().createElement(p.TableRow,{key:e.rowId},l().createElement(p.TableCell,{key:"_checkbox",className:t?"selectedRow":""},l().createElement(h,{rowId:e.rowId,selected:t,onClick:()=>m(e.rowId)})),a.map((n=>l().createElement(p.TableCell,{key:n.columnName,className:t?"selectedRow":""},l().createElement("div",{title:n.tooltip},n.dataElement(e.data[n.columnName].value))))))})))))},f=e=>{const{sortingUnitMetrics:t,units:n,metrics:c,selection:s,selectionDispatch:u,curation:m,sorting:d,height:p}=e,g=(s||{}).selectedUnitIds||[],h=(0,i.Z)(Object.values(t||{})).filter((e=>!e.disabled)),f=(0,o.useCallback)((e=>{u({type:"SetSelectedUnitIds",selectedUnitIds:e.map((e=>Number(e)))})}),[u]),y=n.map((e=>({rowId:e+"",data:{}}))),v=(e,t)=>Number(e)-Number(t),E=e=>l().createElement("span",null,e+""),_={color:"black",fontWeight:"bold",cursor:"pointer"},N={color:"gray",textDecoration:"underline",cursor:"pointer"},C=[];C.push({columnName:"_unit_id",label:"Unit ID",tooltip:"Unit ID",sort:v,dataElement:e=>{const{unitId:t,mergeGroup:n}=e;return l().createElement("span",null,l().createElement("span",{key:"unitId",style:_},t+""),n&&n.length>0&&l().createElement("span",{key:"mergeGroup"},` (${n.map((e=>e+"")).join(", ")})`))}}),y.forEach((e=>{const t=Number(e.rowId);e.data._unit_id={value:{unitId:t,mergeGroup:(0,a.CC)(t,m)},sortValue:t}})),C.push({columnName:"_labels",label:"Labels",tooltip:"Curation labels",sort:(e,t)=>e<t?-1:e>t?1:0,dataElement:e=>{const t=e;return l().createElement("span",null,t.map((e=>l().createElement("span",{key:e},l().createElement("span",{style:N},e),"Â "))))}}),y.forEach((e=>{const t=((e,t)=>((t||{}).labelsByUnit||{})[e]||[])(Number(e.rowId),m);e.data._labels={value:t,sortValue:t.join(", ")}}));const{result:k,job:x}=(0,r.useHitherJob)("createjob_fetch_unit_metrics",{unit_metrics_uri:d.unitMetricsUri||""},{useClientCache:!0});(k||[]).forEach((e=>{const t="external-metric-"+e.name;C.push({columnName:t,label:e.label,tooltip:e.tooltip||"",sort:v,dataElement:E}),y.forEach((n=>{const r=Number(n.rowId),o=e.data[r+""];n.data[t]={value:void 0!==o?o:NaN,sortValue:void 0!==o?o:NaN}}))})),h.forEach((e=>{const t="plugin-metric-"+e.name,n=(c||{})[e.name]||null,r=n?n.data:null;C.push({columnName:t,label:e.columnLabel,tooltip:e.tooltip||"",sort:v,dataElement:e.component,calculating:n&&!r}),y.forEach((n=>{const o=Number(n.rowId),l=r&&o+""in r?r[o+""]:void 0,a=void 0!==l?e.getValue(l):void 0;n.data[t]={value:l,sortValue:void 0!==a?a:e.isNumeric?NaN:""}}))}));const w=g.map((e=>e+""));return l().createElement(b,{rows:y,columns:C,selectedRowIds:w,onSelectedRowIdsChanged:f,defaultSortColumnName:"_unit_id",height:p})}},49101:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>_});var r=n(64122),o=n(56271),l=n.n(o);const a={type:"SortingUnitMetric",name:"EventCount",label:"Num. events",columnLabel:"Num. events",tooltip:"Number of firing events",hitherFnName:"createjob_get_firing_data",metricFnParams:{},hitherOpts:{useClientCache:!0},component:e=>l().createElement("span",null,void 0!==e?e.count:""),isNumeric:!0,getValue:e=>e.count},i={type:"SortingUnitMetric",name:"FiringRate",label:"Firing rate (Hz)",columnLabel:"Firing rate (Hz)",tooltip:"Average num. events per second",hitherFnName:"createjob_get_firing_data",hitherOpts:{useClientCache:!0},metricFnParams:{},component:e=>l().createElement("span",null,void 0!==e?e.rate:""),isNumeric:!0,getValue:e=>e.count},c={type:"SortingUnitMetric",name:"IsiViolations",label:"ISI viol.",columnLabel:"ISI viol.",tooltip:"ISI violation rate",hitherFnName:"createjob_get_isi_violation_rates",metricFnParams:{isi_threshold_msec:2.5},hitherOpts:{useClientCache:!0},component:e=>l().createElement("span",null,void 0!==e?e.toFixed(4):""),isNumeric:!0,getValue:e=>e},s={type:"SortingUnitMetric",name:"PeakChannels",label:"Peak chan.",columnLabel:"Peak chan.",tooltip:"ID of channel where the peak-to-peak amplitude is maximal",hitherFnName:"createjob_get_peak_channels",metricFnParams:{},hitherOpts:{useClientCache:!0},component:e=>l().createElement("span",null,void 0!==e?e:""),isNumeric:!0,getValue:e=>e},u={type:"SortingUnitMetric",name:"UnitSnrs",label:"SNR",columnLabel:"SNR",tooltip:"Unit SNR (peak-to-peak amp of mean waveform / est. std. dev on peak chan)",hitherFnName:"createjob_get_unit_snrs",metricFnParams:{},hitherOpts:{useClientCache:!0},component:e=>l().createElement("span",null,void 0!==e?e.toFixed(4):""),isNumeric:!0,getValue:e=>e};var m=n(47033),d=n(45185),p=n(65405),g=n(49287),h=n(36464),b=n(96333),f=function(e,t,n,r){return new(n||(n=Promise))((function(o,l){function a(e){try{c(r.next(e))}catch(e){l(e)}}function i(e){try{c(r.throw(e))}catch(e){l(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}c((r=r.apply(e,t||[])).next())}))};const y={},v=(e,t)=>{if("clear"===t)return{};const{metricName:n,status:r,data:o,error:l}=t;return e[n]&&"completed"===e[n].status?(console.warn(`Updating status of completed metric ${n}??`),e):Object.assign(Object.assign({},e),{[n]:{status:r,data:"completed"===r&&o||null,error:"error"===r&&l||null}})},E=e=>{const t=(0,o.useContext)(d.HitherContext),{sorting:n,recording:r,selection:a,selectionDispatch:i,curation:c,width:s,height:u}=e,[E,_]=(0,o.useState)(!1),[N,C]=(0,o.useReducer)(v,y),[k,x]=(0,o.useState)(null);(0,o.useEffect)((()=>{k!==r&&(C("clear"),x(r))}),[r,k,x,C]);const w=(0,o.useCallback)((e=>f(void 0,void 0,void 0,(function*(){const o=e.name;if(o in N)return N[o];C({metricName:e.name,status:"executing"});try{const o=yield t.createHitherJob(e.hitherFnName,{sorting_object:n.sortingObject,recording_object:r.recordingObject,configuration:e.metricFnParams},e.hitherOpts).wait();C({metricName:e.name,status:"completed",data:o})}catch(t){console.error(t),C({metricName:e.name,status:"error",error:t.message})}}))),[N,n.sortingObject,r.recordingObject,t]),I=(0,d.usePlugins)();(0,o.useEffect)((()=>{(0,h.Z)((0,g.fG)(I)).filter((e=>!e.disabled)).forEach((e=>f(void 0,void 0,void 0,(function*(){return yield w(e)}))))}),[I,N,w]);const S=(0,o.useMemo)((()=>(0,g.fG)(I)),[I]),j=(0,p.D)(n.sortingObject,n.recordingObject);if(!j)return l().createElement("div",null,"No sorting info");let O=a.visibleUnitIds||j.unit_ids,P=!1;return!E&&O.length>30&&(O=O.slice(0,30),P=!0),l().createElement("div",{style:{width:s||300}},l().createElement(m.Paper,{style:{maxHeight:e.maxHeight,overflow:"auto"}},l().createElement(b.Z,{sortingUnitMetrics:S,units:O,metrics:N,selection:a,selectionDispatch:i,sorting:n,curation:c,height:u}),P&&l().createElement(m.Button,{onClick:()=>{_(!0)}},"Show all units")))};function _(e){(e=>{e.registerPlugin(a),e.registerPlugin(i),e.registerPlugin(c),e.registerPlugin(s),e.registerPlugin(u)})(e),e.registerPlugin({type:"SortingView",name:"UnitsTable",label:"Units Table",icon:l().createElement(r.Z,null),priority:200,component:E,props:{maxHeight:300},singleton:!0})}},95318:e=>{e.exports=function(e){return e&&e.__esModule?e:{default:e}},e.exports.default=e.exports,e.exports.__esModule=!0},20862:(e,t,n)=>{var r=n(50008).default;function o(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return o=function(){return e},e}e.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==r(e)&&"function"!=typeof e)return{default:e};var t=o();if(t&&t.has(e))return t.get(e);var n={},l=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){var i=l?Object.getOwnPropertyDescriptor(e,a):null;i&&(i.get||i.set)?Object.defineProperty(n,a,i):n[a]=e[a]}return n.default=e,t&&t.set(e,n),n},e.exports.default=e.exports,e.exports.__esModule=!0},50008:e=>{function t(n){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?(e.exports=t=function(e){return typeof e},e.exports.default=e.exports,e.exports.__esModule=!0):(e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.default=e.exports,e.exports.__esModule=!0),t(n)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0},64122:(e,t,n)=>{"use strict";var r=n(95318),o=n(20862);t.Z=void 0;var l=o(n(56271)),a=(0,r(n(2108)).default)(l.createElement("path",{d:"M10 10.02h5V21h-5zM17 21h3c1.1 0 2-.9 2-2v-9h-5v11zm3-18H5c-1.1 0-2 .9-2 2v3h19V5c0-1.1-.9-2-2-2zM3 19c0 1.1.9 2 2 2h3V10H3v9z"}),"TableChart");t.Z=a},2108:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return r.createSvgIcon}});var r=n(28546)},97948:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var r=n(23645),o=n.n(r)()((function(e){return e[1]}));o.push([e.id,".TableWidget .MuiTableCell-root {\n    padding-top: 1px;\n    padding-bottom: 1px;\n    padding-left: 0px;\n    padding-right: 0px;\n    font-size: 12px;\n    border: solid 1px #f0f0f0;\n}\n\n.TableWidget .MuiTableCell-root.selectedRow {\n    background-color: #b5d1ff;\n}",""]);const l=o}}]);