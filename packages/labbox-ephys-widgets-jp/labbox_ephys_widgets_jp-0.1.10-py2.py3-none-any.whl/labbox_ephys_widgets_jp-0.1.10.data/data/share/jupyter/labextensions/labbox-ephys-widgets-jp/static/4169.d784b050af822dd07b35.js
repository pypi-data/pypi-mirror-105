(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[4169],{85155:(e,t,n)=>{"use strict";n.d(t,{F0:()=>l,ZL:()=>a});var i=n(45185),r=n(56271);const l=e=>{const{result:t}=(0,i.useHitherJob)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},a=e=>{const t=(0,r.useContext)(i.HitherContext),n=(0,r.useRef)({}),[,l]=(0,r.useState)(0),a={};return e.forEach((e=>{const i=e.recordingId;if(!n.current[i]){const r=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});n.current[i]=r,r.wait().then((()=>{l((e=>e+1))})).catch((()=>{l((e=>e+1))}))}n.current[i].result&&(a[i]=n.current[i].result)})),a}},37249:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(56271),r=n.n(i),l=n(65405),a=n(49287),s=n(96333);const o=({sorting:e,selection:t,selectionDispatch:n,curation:i})=>{const o=(0,l.D)(e.sortingObject,e.recordingObject);if(!o)return r().createElement("div",null,"No sorting info");const c=((null==o?void 0:o.unit_ids)||[]).filter((e=>!t.applyMerges||(0,a.GI)(e,i)));return r().createElement(s.Z,Object.assign({units:c},{selection:t,selectionDispatch:n,sorting:e,curation:i}))}},34169:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>j});var i=n(37030),r=n(56271),l=n.n(r),a=n(45185),s=n(58226),o=n(85155),c=n(65405),u=n(22874),m=n(49287),d=n(48709);const h=["blue","green","red","orange","purple","cyan"],p=e=>{if(Array.isArray(e))return p(Math.min(...e));for(;e<0;)e+=h.length;return h[e%h.length]};class g{constructor(e,t){this.panels=e,this.labelString=t}setTimeRange(e){this.panels.forEach((t=>t.setTimeRange(e)))}paint(e,t){this.panels.forEach((n=>n.paint(e,t)))}paintYAxis(e,t,n){const i=this.panels[0];i&&i.paintYAxis&&i.paintYAxis(e,t,n)}label(){return this.labelString}register(e){this.panels.forEach((t=>t.register((()=>{e()}))))}}const b=(e,t)=>new g(e,t),f=class{constructor(e){this.args=e,this._updateHandler=null,this._timeRange=null,this._calculationScheduled=!1,this._calculationError=null,this._yrange=null,this._globalAmplitudeRange=null,this._includeZero=!0,this._amplitudes=void 0}setTimeRange(e){this._timeRange=e}paint(e,t){const n=this._timeRange;if(!n)return;const i={color:"black"},r={color:p(this.args.unitId)};if(!this.args.spikeAmplitudesData)return;const l=this.args.spikeAmplitudesData.getSpikeAmplitudes(this.args.unitId);if(l&&l.timepoints&&l.amplitudes){const{timepoints:t,amplitudes:a}=l;this._amplitudes=a;let s=this._yrange||this.autoYRange();if(!s)return;this._includeZero&&(s={min:Math.min(0,s.min),max:Math.max(0,s.max)}),e.drawLine(n.min,0,n.max,0,{color:"gray"});const o=t.length;for(let l=0;l<o;l++){const o=t[l],c=(a[l]-s.min)/(s.max-s.min);n.min<=o&&o<=n.max&&e.drawMarker([o,c],{radius:3,pen:i,brush:r})}}else e.drawText({rect:{xmin:n.min,xmax:n.max,ymin:0,ymax:1},alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:12,family:"Arial"},pen:i,brush:r,text:"calculating"})}paintYAxis(e,t,n){((e,t,{label:n})=>{const{xmin:i,xmax:r,ymin:l,ymax:a}=t;e.drawLine(r,l,r,a,{color:"black"}),e.drawText({rect:{xmin:i,xmax:r-10-2,ymin:l,ymax:a},alignment:{Horizontal:"AlignRight",Vertical:"AlignCenter"},font:{family:"Arial",pixelSize:12},pen:{color:"black"},brush:{color:"black"},text:n,orientation:"Vertical"})})(e,{xmin:0,xmax:t,ymin:0,ymax:n},{label:"Spike amplitude"})}label(){return this.args.unitId+""}amplitudeRange(){return this._amplitudes?{min:(0,u.Gt)(this._amplitudes),max:(0,u.lR)(this._amplitudes)}:null}setGlobalAmplitudeRange(e){this._globalAmplitudeRange=e}autoYRange(){return this._globalAmplitudeRange?this._globalAmplitudeRange:this.amplitudeRange()}setYRange(e){this._yrange=e}register(e){this._updateHandler=e}},_=({spikeAmplitudesData:e,recording:t,sorting:n,curation:i,unitIds:h,width:p,height:g,selection:_,selectionDispatch:x})=>{const y=(0,r.useContext)(a.HitherContext),E=(0,c.D)(n.sortingObject,n.recordingObject),v=(0,o.F0)(t.recordingObject),[w,k]=(0,s.Z)(m.SF,_,(0,r.useMemo)((()=>e=>{x({type:"Set",state:e})}),[x]),400),[C,S]=(0,r.useState)(null);(0,r.useEffect)((()=>{const r=[],l=[],a=[];h.forEach((s=>{const o=(0,m.kN)(s,i,w.applyMerges),c=new f({spikeAmplitudesData:e,recording:t,sorting:n,unitId:o,hither:y}),u=e.getSpikeAmplitudes(o);u&&(l.push(u.minAmp),a.push(u.maxAmp)),r.push(c)})),0===r.length&&r.push(new f({spikeAmplitudesData:null,recording:t,sorting:n,unitId:-1,hither:y})),l.length>0&&r.forEach((e=>{e.setGlobalAmplitudeRange({min:(0,u.Gt)(l),max:(0,u.lR)(a)})})),S(r)}),[h,n,y,t,e,w]);const A=(0,r.useMemo)((()=>C?[b(C,"")]:[]),[C]);return E?v?l().createElement(d.Z,{panels:A,width:p,height:g,samplerate:E.samplerate,maxTimeSpan:60*E.samplerate*5,startTimeSpan:60*E.samplerate*1,numTimepoints:v.num_frames,selection:w,selectionDispatch:k}):l().createElement("div",null,"No recording info"):l().createElement("div",null,"No sorting info")};var x=n(50977),y=n(76827),E=function(e,t,n,i){return new(n||(n=Promise))((function(r,l){function a(e){try{o(i.next(e))}catch(e){l(e)}}function s(e){try{o(i.throw(e))}catch(e){l(e)}}function o(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}))};const v=(0,x.zy)({maxSimultaneous:6}),w=(e,t)=>{const n=(0,r.useContext)(x.Zo),i=(0,r.useMemo)((()=>i=>E(void 0,void 0,void 0,(function*(){switch(i.type){case"spikeAmplitudes":return yield(({hither:e,recordingObject:t,sortingObject:n,unitId:i})=>E(void 0,void 0,void 0,(function*(){const r=yield e.createHitherJob("createjob_fetch_spike_amplitudes",{recording_object:t,sorting_object:n,unit_id:i},{useClientCache:!0,calculationPool:v}).wait();return Object.assign(Object.assign({},r),{minAmp:(0,u.Gt)(r.amplitudes),maxAmp:(0,u.lR)(r.amplitudes)})})))({hither:n,recordingObject:e,sortingObject:t,unitId:i.unitId});default:throw Error("Unexpected query type")}}))),[n,e,t]),l=(0,y.Z)(i),a=(0,r.useMemo)((()=>e=>l.get({type:"spikeAmplitudes",unitId:e})),[l]);return(0,r.useMemo)((()=>({getSpikeAmplitudes:a})),[a])},k=e=>{const t=w(e.recording.recordingObject,e.sorting.sortingObject);return t?l().createElement(_,Object.assign({spikeAmplitudesData:t,recording:e.recording,sorting:e.sorting,unitIds:[e.unitId]},{width:e.width||500,height:e.height||500},{selection:e.selection,selectionDispatch:e.selectionDispatch,curation:e.curation})):l().createElement("div",null,"Creating spike amplitudes data...")};var C=n(88493),S=n(37249);const A=({recording:e,sorting:t,selection:n,selectionDispatch:i,curation:r,width:a,height:s})=>{const o=w(e.recordingObject,t.sortingObject);return o?l().createElement(C.Z,{width:a||600,height:s||900,initialPosition:200},l().createElement(S.Z,{sorting:t,selection:n,selectionDispatch:i,curation:r}),l().createElement(_,Object.assign({spikeAmplitudesData:o,recording:e,sorting:t,unitIds:n.selectedUnitIds||[]},{width:0,height:0},{selection:n,selectionDispatch:i,curation:r}))):l().createElement("div",null,"Creating spike amplitudes data...")};function j(e){e.registerPlugin({type:"SortingView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,defaultExpanded:!1,component:A,singleton:!1,icon:l().createElement(i.Z,null)}),e.registerPlugin({type:"SortingUnitView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,fullWidth:!0,component:k,icon:l().createElement(i.Z,null)})}},96333:(e,t,n)=>{"use strict";n.d(t,{Z:()=>f});var i=n(45185),r=n(56271),l=n.n(r),a=n(49287),s=n(36464),o=n(93379),c=n.n(o),u=n(97948);c()(u.Z,{insert:"head",singleton:!1}),u.Z.locals;var m=n(48003),d=n(9756),h=n(47033);const p=e=>{const{columns:t,onColumnClick:n,primarySortColumnDirection:i,primarySortColumnName:r,onDeselectAll:a}=e;return l().createElement(h.TableHead,null,l().createElement(h.TableRow,null,a?l().createElement(h.TableCell,{key:"_checkbox"},l().createElement(g,{rowId:"",selected:!1,onClick:()=>{a()},isDeselectAll:!0})):l().createElement(h.TableCell,{key:"_checkbox"}),t.map((e=>{const t=(e.tooltip||e.label||"")+" (click to sort)";return l().createElement(h.TableCell,{key:e.columnName,onClick:()=>n(e),title:t,style:{cursor:"pointer"}},l().createElement(h.Grid,{container:!0,justify:"flex-start",style:{flexFlow:"row"}},l().createElement(h.Grid,{item:!0,key:"icon"},l().createElement("span",{style:{fontSize:16,color:"gray",paddingLeft:3,paddingRight:5,paddingTop:2}},r===e.columnName&&("ascending"===i?l().createElement(d.FontAwesomeIcon,{icon:m.faCaretUp}):l().createElement(d.FontAwesomeIcon,{icon:m.faCaretDown})))),l().createElement(h.Grid,{item:!0,key:"text"},l().createElement("span",null,l().createElement("span",{key:"label"},e.label),l().createElement("span",{key:"progress"},e.calculating&&l().createElement(h.LinearProgress,null))))))}))))},g=l().memo((e=>{const{rowId:t,selected:n,onClick:i,isDeselectAll:r}=e;return l().createElement(h.Checkbox,{checked:n,indeterminate:!!r,onClick:()=>i(t),style:{padding:1},title:r?"Deselect all":`Select ${t}`})})),b=e=>{const{selectedRowIds:t,onSelectedRowIdsChanged:n,rows:i,columns:a,defaultSortColumnName:s,height:o}=e,[c,u]=(0,r.useState)([]);(0,r.useEffect)((()=>{0===c.length&&s&&u([s])}),[u,c,s]);const m=(0,r.useCallback)((e=>{const i=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(i)}),[t,n]),d=[...i],b=e=>a.filter((t=>t.columnName===e))[0],f=(e=>{const t=[];for(let n=0;n<e.length;n++){const i=e[n-1]!==e[n];t.push({columnName:e[n],keyOrder:n,sortAscending:i})}return t})(c);for(const e of f){const t=e.columnName,n=b(t);d.sort(((i,r)=>{const l=i.data[t]||{},a=r.data[t]||{},s=l.sortValue,o=a.sortValue;return e.sortAscending?n.sort(s,o):n.sort(o,s)}))}const _=(t||[]).reduce(((e,t)=>(e[t]=!0,e)),{}),x=f.length>0?f[f.length-1]:void 0,y=x?x.columnName:void 0,E=x?x.sortAscending?"ascending":"descending":void 0;return l().createElement(h.TableContainer,{style:void 0!==o?{maxHeight:o}:{}},l().createElement(h.Table,{stickyHeader:!0,className:"TableWidget"},l().createElement(p,{columns:a,primarySortColumnName:y,primarySortColumnDirection:E,onColumnClick:e=>{const t=e.columnName;let n=[...c];n=c[c.length-1]===t?c[c.length-2]===t?n.slice(0,n.length-1):[...n,t]:[...n.filter((e=>e!==t)),t],u(n)},onDeselectAll:t.length>0?()=>{n([])}:void 0}),l().createElement(h.TableBody,null,d.map((e=>{const t=_[e.rowId]||!1;return l().createElement(h.TableRow,{key:e.rowId},l().createElement(h.TableCell,{key:"_checkbox",className:t?"selectedRow":""},l().createElement(g,{rowId:e.rowId,selected:t,onClick:()=>m(e.rowId)})),a.map((n=>l().createElement(h.TableCell,{key:n.columnName,className:t?"selectedRow":""},l().createElement("div",{title:n.tooltip},n.dataElement(e.data[n.columnName].value))))))})))))},f=e=>{const{sortingUnitMetrics:t,units:n,metrics:o,selection:c,selectionDispatch:u,curation:m,sorting:d,height:h}=e,p=(c||{}).selectedUnitIds||[],g=(0,s.Z)(Object.values(t||{})).filter((e=>!e.disabled)),f=(0,r.useCallback)((e=>{u({type:"SetSelectedUnitIds",selectedUnitIds:e.map((e=>Number(e)))})}),[u]),_=n.map((e=>({rowId:e+"",data:{}}))),x=(e,t)=>Number(e)-Number(t),y=e=>l().createElement("span",null,e+""),E={color:"black",fontWeight:"bold",cursor:"pointer"},v={color:"gray",textDecoration:"underline",cursor:"pointer"},w=[];w.push({columnName:"_unit_id",label:"Unit ID",tooltip:"Unit ID",sort:x,dataElement:e=>{const{unitId:t,mergeGroup:n}=e;return l().createElement("span",null,l().createElement("span",{key:"unitId",style:E},t+""),n&&n.length>0&&l().createElement("span",{key:"mergeGroup"},` (${n.map((e=>e+"")).join(", ")})`))}}),_.forEach((e=>{const t=Number(e.rowId);e.data._unit_id={value:{unitId:t,mergeGroup:(0,a.CC)(t,m)},sortValue:t}})),w.push({columnName:"_labels",label:"Labels",tooltip:"Curation labels",sort:(e,t)=>e<t?-1:e>t?1:0,dataElement:e=>{const t=e;return l().createElement("span",null,t.map((e=>l().createElement("span",{key:e},l().createElement("span",{style:v},e)," "))))}}),_.forEach((e=>{const t=((e,t)=>((t||{}).labelsByUnit||{})[e]||[])(Number(e.rowId),m);e.data._labels={value:t,sortValue:t.join(", ")}}));const{result:k,job:C}=(0,i.useHitherJob)("createjob_fetch_unit_metrics",{unit_metrics_uri:d.unitMetricsUri||""},{useClientCache:!0});(k||[]).forEach((e=>{const t="external-metric-"+e.name;w.push({columnName:t,label:e.label,tooltip:e.tooltip||"",sort:x,dataElement:y}),_.forEach((n=>{const i=Number(n.rowId),r=e.data[i+""];n.data[t]={value:void 0!==r?r:NaN,sortValue:void 0!==r?r:NaN}}))})),g.forEach((e=>{const t="plugin-metric-"+e.name,n=(o||{})[e.name]||null,i=n?n.data:null;w.push({columnName:t,label:e.columnLabel,tooltip:e.tooltip||"",sort:x,dataElement:e.component,calculating:n&&!i}),_.forEach((n=>{const r=Number(n.rowId),l=i&&r+""in i?i[r+""]:void 0,a=void 0!==l?e.getValue(l):void 0;n.data[t]={value:l,sortValue:void 0!==a?a:e.isNumeric?NaN:""}}))}));const S=p.map((e=>e+""));return l().createElement(b,{rows:_,columns:w,selectedRowIds:S,onSelectedRowIdsChanged:f,defaultSortColumnName:"_unit_id",height:h})}},37030:(e,t,n)=>{"use strict";var i=n(95318),r=n(20862);t.Z=void 0;var l=r(n(56271)),a=(0,i(n(2108)).default)(l.createElement(l.Fragment,null,l.createElement("circle",{cx:"7",cy:"14",r:"3"}),l.createElement("circle",{cx:"11",cy:"6",r:"3"}),l.createElement("circle",{cx:"16.6",cy:"17.6",r:"3"})),"ScatterPlot");t.Z=a},97948:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var i=n(23645),r=n.n(i)()((function(e){return e[1]}));r.push([e.id,".TableWidget .MuiTableCell-root {\n    padding-top: 1px;\n    padding-bottom: 1px;\n    padding-left: 0px;\n    padding-right: 0px;\n    font-size: 12px;\n    border: solid 1px #f0f0f0;\n}\n\n.TableWidget .MuiTableCell-root.selectedRow {\n    background-color: #b5d1ff;\n}",""]);const l=r},50977:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>c,zy:()=>l,lG:()=>m});const i=[];class r{constructor({maxSimultaneous:e,method:t}){this._activeSlots={},this._numActiveSlots=0,this._lastSlotId=-1,this._pendingRequestCallbacks=[],this._paused=!1,this._resumeCallbacks=[],this._maxSimultaneous=e,this._method=t||"queue",i.push(this)}requestSlot(){return e=this,t=void 0,i=function*(){return this._paused?new Promise(((e,t)=>{this._resumeCallbacks.push((()=>{this.requestSlot().then(e).catch(t)}))})):this._numActiveSlots<this._maxSimultaneous?this._createNewSlot():new Promise(((e,t)=>{this._pendingRequestCallbacks.push((t=>{e(t)}))}))},new((n=void 0)||(n=Promise))((function(r,l){function a(e){try{o(i.next(e))}catch(e){l(e)}}function s(e){try{o(i.throw(e))}catch(e){l(e)}}function o(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}));var e,t,n,i}isPaused(){return this._paused}pause(){this._paused||(this._paused=!0,this._resumeCallbacks=[])}resume(){this._paused&&(this._paused=!1,this._resumeCallbacks.forEach((e=>{e()})))}_createNewSlot(){const e=this._lastSlotId+1;return this._lastSlotId=e,this._numActiveSlots++,this._activeSlots[e]={slotId:e,complete:()=>{this._numActiveSlots--,delete this._activeSlots[e],this._update()}},this._activeSlots[e]}_update(){for(;this._pendingRequestCallbacks.length>0&&this._numActiveSlots<this._maxSimultaneous;){let e;if("queue"===this._method)e=this._pendingRequestCallbacks.shift();else{if("stack"!==this._method)throw Error(`Unexpected method in calculation pool: ${this._method}`);e=this._pendingRequestCallbacks.pop()}if(!e)throw Error("unexpected");e(this._createNewSlot())}}}const l=({maxSimultaneous:e,method:t})=>new r({maxSimultaneous:e,method:t});var a=n(56271);const s={jobId:null,functionName:"",kwargs:{},opts:{},clientJobId:"",result:null,runtime_info:{},error_message:null,status:"pending",timestampStarted:0,timestampFinished:null,clientCancelled:!1,wait:()=>{return e=void 0,t=void 0,i=function*(){},new((n=void 0)||(n=Promise))((function(r,l){function a(e){try{o(i.next(e))}catch(e){l(e)}}function s(e){try{o(i.throw(e))}catch(e){l(e)}}function o(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}));var e,t,n,i},cancel:()=>{}},o={createHitherJob:(e,t,n)=>s,getHitherJobs:()=>[]},c=n.n(a)().createContext(o);function u(e,t){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!u(e[n],t[n]))return!1;return!0}if("object"==typeof e){if("object"!=typeof t)return!1;for(let n in e){if(!(n in t))return!1;if(!u(e[n],t[n]))return!1}for(let n in t)if(!(n in e))return!1;return!0}return!1}const m=(e,t,n)=>{var i;const r=(0,a.useContext)(c),[l,o]=(0,a.useState)({status:"pending",functionName:"",hitherJobOpts:{},functionArgs:{},job:null});if(!e)return{result:void 0,job:s};if(e!==l.functionName||!u(t,l.functionArgs)||!u(n,l.hitherJobOpts)){const i=r.createHitherJob(e,t,n);return o({status:"running",functionName:e,functionArgs:t,hitherJobOpts:n,job:i}),i.wait().then((()=>{i.clientCancelled||o({status:"finished",functionName:e,functionArgs:t,hitherJobOpts:n,job:i})})).catch((r=>{i.clientCancelled||o({status:"error",functionName:e,functionArgs:t,hitherJobOpts:n,job:i})})),{result:void 0,job:i}}if(!l.job)throw Error("Unexpected: job is not defined");let m={result:void 0,job:l.job};switch(l.status){case"finished":m.result=null===(i=l.job)||void 0===i?void 0:i.result}return m}}}]);