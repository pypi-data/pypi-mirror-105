(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[890],{46826:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var i=n(46388),s=n.n(i),c=n(69297);const o={data:{},activeFetches:{}},r=(e,t)=>{switch(t.type){case"clear":return o;case"startFetch":return Object.assign(Object.assign({},e),{activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!0})});case"setData":return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{[t.queryHash]:t.data}),activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!1})});default:throw Error("Unexpected action in fetchCacheReducer")}},a=e=>s()(e),l=e=>{const[t,n]=(0,c.useState)(0);t<0&&console.info(t);const i=(0,c.useRef)(e),[s,l]=(0,c.useReducer)(r,o),d=(0,c.useRef)({});(0,c.useEffect)((()=>{e!==i.current&&(i.current=e,l({type:"clear"}))}),[e]);const u=(0,c.useMemo)((()=>e=>{const t=a(e),i=s.data[t];return void 0===i&&(d.current[t]=e,n((e=>e+1))),i}),[s.data]),g=(0,c.useMemo)((()=>t=>{const n=a(t);void 0===s.data[n]&&(s.activeFetches[n]||(l({type:"startFetch",queryHash:n}),e(t).then((e=>{l({type:"setData",queryHash:n,data:e})})).catch((e=>{console.warn(e),console.warn("Problem fetching data",t)}))))}),[s.data,s.activeFetches,e]);return(0,c.useEffect)((()=>{const e=Object.keys(d.current);if(0!==e.length){for(let t of e)g(d.current[t]);d.current={}}})),(0,c.useMemo)((()=>({get:u})),[u])}},26890:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>x});var i=n(69297),s=n.n(i),c=n(3527),o=n(86729),r=n(81459),a=n(28361),l=n.n(a),d=n(15743),u=n(25212),g=n(10626),h=n(5443),p=n(63514),m=n(46826),b=n(95849),v=n(47449);const f=({snippet:e,noiseLevel:t,samplingFrequency:n,electrodeIds:c,electrodeLocations:o,selection:r,selectionDispatch:a,width:d,height:u})=>{const[g,h]=(0,i.useState)(!1),p=(0,i.useCallback)((e=>{e&&!g&&h(!0)}),[g,h]),m=(null==e?void 0:e.timepoint)||0,b=r.currentTimepoint||0,f=(0,i.useMemo)((()=>Math.abs(m-b)<20),[m,b]),y=(0,i.useCallback)((()=>{e&&a({type:"SetCurrentTimepoint",currentTimepoint:e.timepoint})}),[e,a]);return s().createElement(l(),{onChange:p,partialVisibility:!0},g&&e?s().createElement("div",{className:f?"plotSelectedStyle":"",onClick:y},s().createElement(v.Z,Object.assign({waveform:e.waveform,layoutMode:r.waveformsMode||"geom"},{selection:r,selectionDispatch:a,noiseLevel:t,samplingFrequency:n,electrodeIds:c,electrodeLocations:o,width:d,height:u},{electrodeOpts:{disableSelection:!0}}))):s().createElement("div",{style:{position:"absolute",width:d,height:u}}))};var y=function(e,t,n,i){return new(n||(n=Promise))((function(s,c){function o(e){try{a(i.next(e))}catch(e){c(e)}}function r(e){try{a(i.throw(e))}catch(e){c(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,r)}a((i=i.apply(e,t||[])).next())}))};const w=(0,h.zy)({maxSimultaneous:6}),_=3e5,j=(e,t,n)=>{var i;return t&&n?Object.assign(Object.assign({},e),{waveform:null===(i=e.waveform)||void 0===i?void 0:i.filter(((e,i)=>n.includes(t[i])))}):e},E=({recording:e,sorting:t,selection:n,selectionDispatch:c,curation:o,unitId:r,height:a,noiseLevel:l})=>{const{snippets:d,info:v}=(e=>{const t=(0,i.useContext)(h.Zo),{recording:n,sorting:s,selection:c,curation:o,visibleElectrodeIds:r,unitId:a,timeRange:l}=e,d=(0,i.useMemo)((()=>e=>y(void 0,void 0,void 0,(function*(){switch(e.type){case"info":const n=(0,b.kN)(e.unitId,o,c.applyMerges);return yield(e=>y(void 0,void 0,void 0,(function*(){const{recording:t,sorting:n,unitId:i,hither:s}=e,c=yield s.createHitherJob("createjob_get_sorting_unit_info",{recording_object:t.recordingObject,sorting_object:n.sortingObject,unit_id:i},{useClientCache:!0,calculationPool:w}).wait();return{channel_ids:c.channel_ids,channel_locations:c.channel_locations,sampling_frequency:c.sampling_frequency}})))({recording:e.recording,sorting:e.sorting,unitId:n,hither:t});case"snippets":const i=(0,b.kN)(e.unitId,o,c.applyMerges);return yield(e=>y(void 0,void 0,void 0,(function*(){const{recording:t,sorting:n,unitId:i,timeRange:s,hither:c}=e;return(yield c.createHitherJob("createjob_get_sorting_unit_snippets",{recording_object:t.recordingObject,sorting_object:n.sortingObject,unit_id:i,time_range:s,max_num_snippets:1e3},{useClientCache:!0,calculationPool:w}).wait()).snippets})))({recording:e.recording,sorting:e.sorting,unitId:i,timeRange:e.timeRange,hither:t})}}))),[t,o,c.applyMerges]),u=(0,m.Z)(d);return(0,i.useMemo)((()=>{const e={type:"info",recording:n,sorting:s,unitId:a},t=u.get(e),i=((e,t)=>{const n=[];if(!e)return n;const i=Math.floor(e.min/_),s=Math.ceil(e.max/_);for(let e=i;e<=Math.min(s,i+t.maxNumSegments-1);e++)n.push({min:e*_,max:(e+1)*_});return n})(l,{maxNumSegments:6}).map((e=>{const t={type:"snippets",recording:n,sorting:s,unitId:a,timeRange:e};return u.get(t)})).reduce(((e,t)=>t?e.concat(t):e),[]).map((e=>j(e,null==t?void 0:t.channel_ids,r))),c=i?i.filter((e=>l&&l.min<=e.timepoint&&e.timepoint<l.max)):void 0;return{info:t?Object.assign(Object.assign({},t),{channel_ids:t.channel_ids.filter(((e,n)=>!r||r.includes(t.channel_ids[n]))),channel_locations:t.channel_locations.filter(((e,n)=>!r||r.includes(t.channel_ids[n])))}):void 0,snippets:c}}),[u,n,s,l,a,r])})({recording:e,sorting:t,selection:n,curation:o,visibleElectrodeIds:n.visibleElectrodeIds,unitId:r,timeRange:n.timeRange||null}),E=null==v?void 0:v.channel_locations,O=(0,i.useMemo)((()=>{if("geom"===n.waveformsMode){const e=(E?(0,p.g)(E):1)||1;return e>1?a/e:a*e}return 100}),[E,a,n.waveformsMode]),I=(0,i.useMemo)((()=>({width:O+5,height:a+15})),[O,a]);return s().createElement(u.Z,{style:{flexWrap:"nowrap",height:a+15}},v&&E&&d?d.length>0?d.map((e=>s().createElement(g.Z,{key:e.timepoint,style:I},s().createElement(f,{snippet:e,noiseLevel:l,samplingFrequency:v.sampling_frequency,electrodeIds:v.channel_ids,electrodeLocations:E,selection:n,selectionDispatch:c,width:O,height:a})))):s().createElement(g.Z,{style:Object.assign(Object.assign({},I),{width:500,color:"gray"})},s().createElement("div",null,"No snippets found in selected time range")):s().createElement(g.Z,{style:Object.assign(Object.assign({},I),{width:180})},s().createElement("div",{style:{whiteSpace:"nowrap"}},"Retrieving snippets...")))},O=({width:e,height:t,children:n})=>{const[c,o]=(0,i.useState)(!1),r=(0,i.useCallback)((e=>{e&&!c&&o(!0)}),[c,o]);return c?s().createElement(i.Fragment,null,n):s().createElement(l(),{onChange:r,partialVisibility:!0},s().createElement("div",{className:"WhenVisible",style:{position:"absolute",width:e,height:t}},"Waiting for visible"))},I=({recording:e,sorting:t,selection:n,selectionDispatch:i,curation:c,unitIds:o,width:a,height:l})=>{const u=((0,d.F0)(e.recordingObject)||{}).noise_level||1;return s().createElement("div",{style:{position:"absolute",width:a,height:l,overflow:"auto"}},s().createElement(r.Z,{container:!0,direction:"column"},(o||[]).map((o=>s().createElement(r.Z,{item:!0,key:o,style:{border:"solid 3px lightgray",marginBottom:2}},s().createElement("h3",{style:{paddingTop:0,paddingBottom:0,marginTop:10,marginBottom:10}},"Snippets for unit ",o),s().createElement(O,{width:a,height:250},s().createElement(E,Object.assign({},{recording:e,sorting:t,selection:n,selectionDispatch:i,curation:c,unitId:o,height:250,noiseLevel:u}))))))))},M=({recording:e,sorting:t,selection:n,selectionDispatch:i,curation:r,width:a,height:l})=>s().createElement(c.Z,{width:a||600,height:l||900,initialPosition:200},s().createElement(o.Z,{sorting:t,selection:n,selectionDispatch:i,curation:r}),s().createElement(I,Object.assign({recording:e,sorting:t,selection:n,selectionDispatch:i,curation:r,unitIds:n.selectedUnitIds||[]},{width:0,height:0})));function x(e){e.registerPlugin({type:"SortingView",name:"SnippetsView",label:"Snippets",priority:50,component:M})}},86729:(e,t,n)=>{"use strict";n.d(t,{Z:()=>a});var i=n(69297),s=n.n(i),c=n(10051),o=n(95849),r=n(3940);const a=({sorting:e,selection:t,selectionDispatch:n,curation:i})=>{const a=(0,c.D)(e.sortingObject,e.recordingObject);if(!a)return s().createElement("div",null,"No sorting info");const l=((null==a?void 0:a.unit_ids)||[]).filter((e=>!t.applyMerges||(0,o.GI)(e,i)));return s().createElement(r.Z,Object.assign({units:l},{selection:t,selectionDispatch:n,sorting:e,curation:i}))}}}]);