(self.webpackChunkbqplot_image_gl=self.webpackChunkbqplot_image_gl||[]).push([[389],{922:function(e,t,s){"use strict";var a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const i=a(s(6325)).BaseXYSelector,n=s(6375),r=(s(6633),s(5305)),{applyStyles:l}=(s(6175),s(6988)),o=function(){return s(6175).event}.bind(this);t.BrushEllipseSelector=class extends i{constructor(){super(...arguments),this.brushStartPosition={x:0,y:0},this.moveStartPosition={x:0,y:0},this.reshapeStartAngle=0,this.reshapeStartRadii={rx:0,ry:0}}async render(){super.render();const e=this.create_scales();await Promise.all([this.mark_views_promise,e]),this.create_listeners();const t=n.select(this.d3el.node());t.attr("clip-path","url(#"+this.parent.clip_id+")"),this.eventElement=t.append("rect").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.height).attr("pointer-events","all").style("cursor","crosshair").style("visibility","hidden"),t.attr("class","selector brushintsel"),this.brush=t.append("g").style("visibility","visible"),this.d3ellipseHandle=this.brush.append("ellipse"),this.d3ellipse=this.brush.append("ellipse"),this.eventElement.call(r.drag().on("start",(()=>{const e=o();this._brushStart({x:e.x,y:e.y})})).on("drag",(()=>{const e=o();this._brushDrag({x:e.x,y:e.y})})).on("end",(()=>{const e=o();this._brushEnd({x:e.x,y:e.y})}))),this.d3ellipse.call(r.drag().on("start",(()=>{const e=o();this._moveStart({x:e.x,y:e.y})})).on("drag",(()=>{const e=o();this._moveDrag({x:e.x,y:e.y})})).on("end",(()=>{const e=o();this._moveEnd({x:e.x,y:e.y})}))),this.d3ellipseHandle.call(r.drag().on("start",(()=>{const e=o();this._reshapeStart({x:e.x,y:e.y})})).on("drag",(()=>{const e=o();this._reshapeDrag({x:e.x,y:e.y})})).on("end",(()=>{const e=o();this._reshapeEnd({x:e.x,y:e.y})}))),this.updateEllipse(),this.syncSelectionToMarks(),this.listenTo(this.model,"change:selected_x change:selected_y change:color change:style change:border_style",(()=>this.updateEllipse())),this.listenTo(this.model,"change:selected_x change:selected_y",this.syncSelectionToMarks)}relayout(){super.relayout(),this.x_scale.set_range(this.parent.padded_range("x",this.x_scale.model)),this.y_scale.set_range(this.parent.padded_range("y",this.y_scale.model)),this.eventElement.attr("width",this.parent.width-this.parent.margin.left-this.parent.margin.right).attr("height",this.parent.height-this.parent.margin.top-this.parent.margin.bottom),this.updateEllipse()}remove(){super.remove(),n.select(this.parent.bg_events.node()).on(".start .drag .end",null)}_brushStart({x:e,y:t}){console.log("start",e,t),this.brushStartPosition={x:e,y:t},this.model.set("brushing",!0),this.touch()}_brushDrag({x:e,y:t}){console.log("drag",e,t),this._brush({x:e,y:t})}_brushEnd({x:e,y:t}){console.log("end",e,t),this._brush({x:e,y:t}),this.model.set("brushing",!1),this.touch()}_brush({x:e,y:t}){const s=this.brushStartPosition.x,a=this.brushStartPosition.y,i=Math.abs(e-s),n=Math.abs(t-a);if(!this.model.get("pixel_aspect")&&(0==i||0==n))return console.log("cannot draw ellipse"),this.model.set("selected_x",null),this.model.set("selected_y",null),void this.touch();let r=this.model.get("pixel_aspect")||i/n;const l=Math.sqrt(n*n*r*r+i*i),o=l/r,[h,d,c,m]=[s-l,s+l,a-o,a+o];if(h!=d||c!=m){let e=[h,d].map((e=>this.x_scale.scale.invert(e))),t=[c,m].map((e=>this.y_scale.scale.invert(e)));this.model.set("selected_x",new Float32Array(e)),this.model.set("selected_y",new Float32Array(t)),this.touch()}else this.model.set("selected_x",null),this.model.set("selected_y",null),this.touch()}_moveStart({x:e,y:t}){this.moveStartPosition={x:e,y:t},this.model.set("brushing",!0),this.touch()}_moveDrag({x:e,y:t}){this._move({dx:e-this.moveStartPosition.x,dy:t-this.moveStartPosition.y}),this.moveStartPosition={x:e,y:t}}_moveEnd({x:e,y:t}){this._move({dx:e-this.moveStartPosition.x,dy:t-this.moveStartPosition.y}),this.model.set("brushing",!1),this.touch()}_move({dx:e,dy:t}){const{px1:s,px2:a,py1:i,py2:n}=this.calculatePixelCoordinates();let r=[s,a].map((t=>this.x_scale.scale.invert(t+e))),l=[i,n].map((e=>this.y_scale.scale.invert(e+t)));this.model.set("selected_x",new Float32Array(r)),this.model.set("selected_y",new Float32Array(l)),this.touch()}_reshapeStart({x:e,y:t}){const{cx:s,cy:a,rx:i,ry:n}=this.calculatePixelCoordinates();if(this.model.get("pixel_aspect"))this._brushStart({x:s,y:a}),this._brushDrag({x:e,y:t});else{const r=e-s,l=t-a;this.reshapeStartAngle=Math.atan2(i*l,n*r),this.reshapeStartRadii={rx:i,ry:n}}this.model.set("brushing",!0),this.touch()}_reshapeDrag({x:e,y:t}){this.model.get("pixel_aspect")?this._brushDrag({x:e,y:t}):this._reshape({x:e,y:t,angle:this.reshapeStartAngle})}_reshapeEnd({x:e,y:t}){this.model.get("pixel_aspect")?this._brushEnd({x:e,y:t}):this._reshape({x:e,y:t,angle:this.reshapeStartAngle}),this.model.set("brushing",!1),this.touch()}_reshape({x:e,y:t,angle:s}){const{cx:a,cy:i}=this.calculatePixelCoordinates();s=(s+2*Math.PI)%(2*Math.PI);for(let e=0;e<5;e++){const t=Math.PI*e/2,a=t-10*Math.PI/180,i=t+10*Math.PI/180;console.log("test angle",t,a,i,s>a&&s<i),s>a&&s<i&&(s=t)}s=(s+2*Math.PI)%(2*Math.PI);const n=e-a,r=t-i;let l=this.model.get("pixel_aspect"),o=n/Math.cos(s),h=r/Math.sin(s);s!=Math.PI/2&&s!=3*Math.PI/2||(o=l?h/l:this.reshapeStartRadii.rx),0!=s&&s!=Math.PI||(h=l?o*l:this.reshapeStartRadii.ry);const[d,c,m,u]=[a-o,a+o,i-h,i+h];let _=[d,c].map((e=>this.x_scale.scale.invert(e))),p=[m,u].map((e=>this.y_scale.scale.invert(e)));this.model.set("selected_x",new Float32Array(_)),this.model.set("selected_y",new Float32Array(p)),this.touch()}reset(){this.model.set("selected_x",null),this.model.set("selected_y",null),this.touch()}selected_changed(){}canDraw(){const e=this.model.get("selected_x"),t=this.model.get("selected_y");return Boolean(e)&&Boolean(t)}calculatePixelCoordinates(){if(!this.canDraw())throw new Error("No selection present");const e=this.model.get("selected_x"),t=this.model.get("selected_y");var s=(e,t)=>e-t;let a=[...e].sort(s),i=[...t].sort(s),[n,r]=a.map((e=>this.x_scale.scale(e))),[l,o]=i.map((e=>this.y_scale.scale(e)));return{px1:n,px2:r,py1:l,py2:o,cx:(n+r)/2,cy:(l+o)/2,rx:Math.abs(r-n)/2,ry:Math.abs(o-l)/2}}updateEllipse(e=0,t=0,s=0,a=0){if(this.canDraw()){const{cx:i,cy:n,rx:r,ry:o}=this.calculatePixelCoordinates();this.d3ellipse.attr("cx",i+e).attr("cy",n+t).attr("rx",r+s).attr("ry",o+a).style("fill",this.model.get("color")||"grey"),l(this.d3ellipse,this.model.get("style")),this.d3ellipseHandle.attr("cx",i+e).attr("cy",n+t).attr("rx",r+s).attr("ry",o+a).style("stroke",this.model.get("color")||"black"),l(this.d3ellipseHandle,this.model.get("border_style")),this.brush.node().style.display=""}else this.brush.node().style.display="none"}syncSelectionToMarks(){if(!this.canDraw())return;const{cx:e,cy:t,rx:s,ry:a}=this.calculatePixelCoordinates(),i=function(i){const[n,r]=i,l=(e-n)/s,o=(t-r)/a;return l*l+o*o<=1},n=function(e){return console.error("Rectangle selector not implemented"),!1};this.mark_views.forEach((e=>{e.selector_changed(i,n)}))}}},5588:(e,t,s)=>{"use strict";var a=s(8657).i;Object.defineProperty(t,"X",{value:!0});const i=s(6325).BrushSelectorModel;class n extends i{defaults(){return Object.assign({},i.prototype.defaults(),{_model_module:"bqplot-image-gl",_view_module:"bqplot-image-gl",_model_module_version:a,_view_module_version:a,_model_name:"BrushEllipseSelectorModel",_view_name:"BrushEllipseSelector",pixel_aspect:null,style:{fill:"green",opacity:.3,cursor:"grab"},border_style:{fill:"none",stroke:"green",opacity:.3,cursor:"col-resize","stroke-width":"3px"}})}}n.serializers=Object.assign({},i.serializers),t.S=n},7206:function(e,t,s){"use strict";var a=s(8657).i;Object.defineProperty(t,"__esModule",{value:!0});const i=s(6325),n=s(7145),r=s(6375),l=s(5305),o=s(5431),h=s(6175),d=function(){return s(6175).event||window.event}.bind(this),c=["click","dblclick","mouseenter","mouseleave","contextmenu"],m=["keydown","keyup"],u=["mousemove"],_=["start","drag","end"];class p extends n.WidgetModel{defaults(){return Object.assign({},n.WidgetModel.prototype.defaults(),{_model_name:"MouseInteractionModel",_view_name:"MouseInteraction",_model_module:"bqplot-image-gl",_view_module:"bqplot-image-gl",_model_module_version:a,_view_module_version:a,scale_x:null,scale_y:null,scale_y:null,move_throttle:50,cursor:"auto",next:null,events:[]})}}p.serializers=Object.assign({},n.WidgetModel.serializers,{x_scale:{deserialize:n.unpack_models},y_scale:{deserialize:n.unpack_models},next:{deserialize:n.unpack_models}}),t.MouseInteractionModel=p;class g extends i.Interaction{async render(){super.render(),this.eventElement=r.select(this.parent.interaction.node()),this.nextView=null,this.x_scale=await this.create_child_view(this.model.get("x_scale")),this.y_scale=await this.create_child_view(this.model.get("y_scale")),this.last_mouse_point=[-1,-1],this.parent.on("margin_updated",this.updateScaleRanges,this),this.updateScaleRanges();const e=()=>{this.eventElement.node().style.cursor=this.model.get("cursor")};this.listenTo(this.model,"change:cursor",e),this.listenTo(this.model,"change:next",this.updateNextInteract),e();const t=()=>{this._emitThrottled=o.throttle(this._emit,this.model.get("move_throttle"))};t(),this.listenTo(this.model,"change:move_throttle",t),this.listenTo(this.model,"change:events",(()=>{this.unbindEvents(),this.bindEvents()})),this.bindEvents(),this.updateNextInteract()}bindEvents(){this.model.get("events"),(this.eventEnabled("dragstart")||this.eventEnabled("dragmove")||this.eventEnabled("dragend"))&&this.eventElement.call(l.drag().on(this._eventName("start"),(()=>{const e=d();this._emit("dragstart",{x:e.x,y:e.y})})).on(this._eventName("drag"),(()=>{const e=d();this._emit("dragmove",{x:e.x,y:e.y})})).on(this._eventName("end"),(()=>{const e=d();this._emit("dragend",{x:e.x,y:e.y})}))),c.forEach((e=>{this.eventElement.on(this._eventName(e),(()=>{this._emitThrottled.flush(),"mouseleave"!==e&&(this.parent.el.setAttribute("tabindex",-1),this.parent.el.focus()),"mouseleave"===e&&this.parent.el.removeAttribute("tabindex");const t=d(),[s,a]=h.clientPoint(this.eventElement.node(),t);return this.model.get("events"),"contextmenu"==e&&this.eventEnabled("contextmenu")&&(t.preventDefault(),t.stopPropagation()),this._emit(e,{x:s,y:a},{button:t.button,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey}),!1}))})),m.forEach((e=>{r.select(this.parent.el).on(this._eventName(e),(()=>{this._emitThrottled.flush();const t=d(),[s,a]=this.last_mouse_point;return t.preventDefault(),t.stopPropagation(),this._emit(e,{x:s,y:a},{code:t.code,charCode:t.charCode,key:t.key,keyCode:t.keyCode,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey}),!1}))})),u.forEach((e=>{this.eventElement.on(this._eventName(e),(()=>{const t=d(),[s,a]=h.clientPoint(this.eventElement.node(),t);this.last_mouse_point=[s,a],this._emitThrottled(e,{x:s,y:a})}))}))}_eventName(e){return`${e}.${this.cid}`}unbindEvents(){const e=e=>this.eventElement.on(this._eventName(e),null);c.forEach(e),m.forEach(e),u.forEach(e),_.forEach(e)}eventEnabled(e){const t=this.model.get("events");return null==t||t.includes(e)}async updateNextInteract(){await this.displayed;const e=this.model.get("next");this.nextView&&this.nextView.remove(),e&&(this.nextView=await this.parent.create_child_view(e),this.parent.interaction.node().appendChild(this.nextView.el),this.parent.displayed.then((()=>{this.nextView.trigger("displayed")})))}updateScaleRanges(){this.x_scale.set_range(this.parent.padded_range("x",this.x_scale.model)),this.y_scale.set_range(this.parent.padded_range("y",this.y_scale.model))}remove(){super.remove(),this.nextView&&this.nextView.remove(),this.unbindEvents(),this.parent.off("margin_updated",this.updateScaleRanges),this.parent.el.removeAttribute("tabindex"),this._emitThrottled.flush()}_emit(e,{x:t,y:s},a){if(!this.eventEnabled(e))return;let i={x:this.x_scale.scale.invert(t),y:this.y_scale.scale.invert(s)};this.send({event:e,pixel:{x:t,y:s},domain:i,...a})}}t.MouseInteraction=g},2596:(e,t,s)=>{"use strict";s.d(t,{E:()=>d,f:()=>c});var a=s(6325),i=s(7145),n=s(138),r=s(8095),l=s(6375),o=s(9562),h=s(8657).i;class d extends a.MarkModel{defaults(){return _.extend(a.MarkModel.prototype.defaults(),{_model_name:"ContourModel",_view_name:"ContourView",_model_module:"bqplot-image-gl",_view_module:"bqplot-image-gl",_model_module_version:h,_view_module_version:h,image:null,level:null,color:null,scales_metadata:{x:{orientation:"horizontal",dimension:"x"},y:{orientation:"vertical",dimension:"y"}}})}initialize(e,t){super.initialize(e,t),this.on_some_change(["level","contour_lines"],this.update_data,this),this.update_data()}update_data(){const e=this.get("image"),t=this.get("level");if(this.thresholds=Array.isArray(t)?t:[t],e){const t=e.get("image");this.width=t.shape[1],this.height=t.shape[0],this.contours=this.thresholds.map((e=>n.contours().size([this.width,this.height]).contour(t.data,[e])))}else{this.width=1,this.height=1;const e=this.get("contour_lines");this.contours=e.map((e=>({type:"MultiLineString",coordinates:e.map((e=>{for(var t=[],s=0;s<e.size/2;s++)t.push([e.get(s,0),e.get(s,1)]);return t}))})))}this.trigger("data_updated")}}class c extends a.Mark{create_listeners(){super.create_listeners(),this.listenTo(this.model,"change:label_steps change:label",(()=>{this.updateLabels()})),this.listenTo(this.parent,"margin_updated",(()=>{this.set_ranges(),this.updatePaths(),this.updateLabels()})),this.listenTo(this.model,"change:color",(()=>{this.updatePaths(),this.updateLabels()})),this.listenTo(this.model,"data_updated",(()=>{this.updatePaths(),this.updateLabels()}))}set_positional_scales(){var e=this.scales.x,t=this.scales.y;this.listenTo(e,"domain_changed",(function(){this.updatePaths(),this.updateLabels()})),this.listenTo(t,"domain_changed",(function(){this.updatePaths(),this.updateLabels()}))}updateColors(){const e=this.getColor();this.paths.data(this.model.thresholds).attr("stroke",this.getColor.bind(this)),this.d3path.attr("stroke",e),this.d3label_group.selectAll("text").attr("fill",e)}getColor(e,t){let s=this.model.get("color");if(s){const e=Array.isArray(s)?s:[s];return e[t%e.length]}this.model;var a=this.scales.image.model.color_range,i=l.scaleLinear().range(a).domain(this.scales.image.model.domain);const n=this.scales.image.model.domain[0],r=this.scales.image.model.domain[this.scales.image.model.domain.length-1]-n;return s=i((e-n+r/2)%r+n),s}createPath(e){const t=this.scales.x,s=this.scales.y,a=this.model;var i=r.geoTransform({point:function(e,i){this.stream.point(t.scale(e/a.width),s.scale(i/a.height))}});return r.geoPath(i)(this.model.contours[e])}render(){const e=super.render();return e.then((()=>{this.draw(),this.create_listeners()})),e}set_ranges(){var e=this.scales.x,t=this.scales.y;e&&e.set_range(this.parent.padded_range("x",e.model)),t&&t.set_range(this.parent.padded_range("y",t.model))}draw(){this.d3path=this.d3el.append("g"),this.d3label_group=this.d3el.append("g"),this.updatePaths(),this.updateLabels()}updatePaths(){this.paths=this.d3el.select("g").selectAll("path").data(this.model.thresholds);const e=this.paths.enter().append("path");this.paths.merge(e).attr("stroke",this.getColor.bind(this)).attr("fill","none").attr("d",((e,t)=>this.createPath(t))).attr("mask",this.mask_id),this.paths.exit().remove()}updateLabels(){const e=this.scales.x,t=this.scales.y,s=this.model;this.d3label_group.html(null),this.parent.margin,this.model.contours.forEach(((a,i)=>{const n=this.getColor(s.thresholds[i],i);let r=this.model.get("label");if(r){const e=Array.isArray(r)?r:[r];r=e[i%e.length]}else r=String(s.thresholds[i]);const l="MultiPolygon"==a.type;a.coordinates.forEach((a=>{(l?a:[a]).forEach(((a,i)=>{const o=l?a.slice(1):a;var h=0;const d=this.model.get("label_steps"),c=t=>e.scale(t/s.width),m=e=>t.scale(e/s.height);for(;h<o.length;){const e=(h-1+o.length)%o.length,t=(h+1+o.length)%o.length,s=c(o[h][0]),a=m(o[h][1]),i=c(o[e][0]),l=m(o[e][1]),_=c(o[t][0])-i,p=m(o[t][1])-l;var u=(180*Math.atan2(p,_)/Math.PI+180)%360;if(u>270&&(u=(u+180)%360),u>90&&(u=(u+180)%360),this.d3label_group.append("text").text(r).attr("transform",`translate(${s}, ${a}) rotate(${u})`).attr("text-anchor","middle").attr("fill",n),(h+=d)>o.length-1.2*d)break}}))}))}))}}d.serializers=Object.assign({},a.MarkModel.serializers,{image:{deserialize:i.unpack_models},contour_lines:{deserialize:(e,t)=>e.map((e=>e.map((e=>{let t={buffer:e.value,dtype:e.dtype,shape:e.shape};return o.JSONToArray(t)}))))}})},8365:(e,t,s)=>{"use strict";s.d(t,{c:()=>m,t:()=>u});var a=s(8657).i,i=s(7145),n=s(5431),r=s(6375),l=s(6325),o=s(9600),h={nearest:o.NearestFilter,bilinear:o.LinearFilter},d=s(9562),c=s(1961);class m extends l.MarkModel{defaults(){return n.extend(l.MarkModel.prototype.defaults(),{_model_name:"ImageGLModel",_view_name:"ImageGLView",_model_module:"bqplot-image-gl",_view_module:"bqplot-image-gl",_model_module_version:a,_view_module_version:a,interpolation:"nearest",opacity:1,x:1,y:1,scales_metadata:{x:{orientation:"horizontal",dimension:"x"},y:{orientation:"vertical",dimension:"y"}}})}initialize(e,t){super.initialize(e,t),this.on_some_change(["x","y"],this.update_data,this),this.on_some_change(["preserve_domain"],this.update_domains,this),this.update_data()}update_data(){this.mark_data={x:this.get("x"),y:this.get("y")},this.update_domains(),this.trigger("data_updated")}update_domains(){if(this.mark_data){var e=this.get("scales"),t=e.x,s=e.y;t&&(this.get("preserve_domain").x?t.del_domain([],this.model_id+"_x"):t.compute_and_set_domain(this.mark_data.x,this.model_id+"_x")),s&&(this.get("preserve_domain").y?s.del_domain([],this.model_id+"_y"):s.compute_and_set_domain(this.mark_data.y,this.model_id+"_y"))}}}m.serializers=Object.assign({},l.MarkModel.serializers,{x:c.array_or_json,y:c.array_or_json,image:{deserialize:(e,t)=>{let s={buffer:e.value,dtype:e.dtype,shape:e.shape};return d.JSONToArray(s)},serialize:e=>{const{buffer:t,dtype:s,shape:a}=d.arrayToJSON(e);return{value:t,dtype:s,shape:a}}}});class u extends l.Mark{render(){var e=super.render();return window.last_image=this,this.image_plane=new o.PlaneBufferGeometry(1,1),this.image_material=new o.ShaderMaterial({uniforms:{image:{type:"t",value:null},colormap:{type:"t",value:null},color_min:{type:"f",value:0},color_max:{type:"f",value:1},domain_x:{type:"2f",value:[0,1]},domain_y:{type:"2f",value:[0,1]},range_x:{type:"2f",value:[0,1]},range_y:{type:"2f",value:[0,1]},image_domain_x:{type:"2f",value:[0,1]},image_domain_y:{type:"2f",value:[0,1]},opacity:{type:"f",value:1}},vertexShader:s(3830).Z,fragmentShader:s(8288).Z,transparent:!0,alphaTest:.01,blending:o.CustomBlending,depthTest:!1,depthWrite:!1,blendEquation:o.AddEquation,blendSrc:o.OneFactor,blendDst:o.OneMinusSrcAlphaFactor,blendEquationAlpha:o.AddEquation,blendSrcAlpha:o.OneFactor,blendDstAlpha:o.OneMinusSrcAlphaFactor}),this.image_mesh=new o.Mesh(this.image_plane,this.image_material),this.camera=new o.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4),this.camera.position.z=10,this.scene=new o.Scene,this.scene.add(this.image_mesh),e.then((()=>{this.create_listeners(),this.update_minmax(),this.update_colormap(),this.update_opacity(),this.update_image(),this.update_scene(),this.listenTo(this.parent,"margin_updated",(()=>{this.update_scene(),this.draw()}))}))}set_positional_scales(){var e=this.scales.x,t=this.scales.y;this.listenTo(e,"domain_changed",(function(){this.model.dirty||this.update_scene()})),this.listenTo(t,"domain_changed",(function(){this.model.dirty||this.update_scene()}))}set_ranges(){var e=this.scales.x,t=this.scales.y;e&&e.set_range(this.parent.padded_range("x",e.model)),t&&t.set_range(this.parent.padded_range("y",t.model))}create_listeners(){super.create_listeners(),this.listenTo(this.model,"change:interpolation",(()=>{this.texture&&(this.texture.magFilter=h[this.model.get("interpolation")],this.texture.minFilter=h[this.model.get("interpolation")],this.texture.needsUpdate=!0,this.image_material.needsUpdate=!0,this.update_scene())}));var e=()=>{this.image_material.visible=this.model.get("visible"),this.update_scene()};this.listenTo(this.model,"change:visible",e,this),e(),this.listenTo(this.model,"change:opacity",(()=>{this.update_opacity(),this.update_scene()}),this),this.listenTo(this.scales.image.model,"domain_changed",(()=>{this.update_minmax(),this.update_scene()}),this),this.listenTo(this.scales.image.model,"colors_changed",(()=>{this.update_colormap(),this.update_scene()}),this),this.listenTo(this.scales.image.model,"domain_changed",this.update_image,this),this.listenTo(this.model,"change:image",(()=>{this.update_image(),this.update_scene()}),this),this.listenTo(this.model,"data_updated",(function(){this.update_scene(!0)}),this)}update_minmax(){var e=this.scales.image.model.get("min"),t=this.scales.image.model.get("max");"number"!=typeof e&&(e=0),"number"!=typeof t&&(t=0),this.image_material.uniforms.color_min.value=e,this.image_material.uniforms.color_max.value=t}update_opacity(){this.image_material.uniforms.opacity.value=this.model.get("opacity")}update_colormap(){var e=this.scales.image.model.color_range,t=r.scaleLinear().range(e).domain(n.range(e.length).map((t=>t/(e.length-1)))),s=[];n.map(n.range(256),(e=>{var a=t(e/255);a=function(e){var t=/.([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})/.exec(e);if(t)return[parseInt("0x"+t[1]),parseInt("0x"+t[2]),parseInt("0x"+t[3])];var s=/rgb\((\d+), (\d+), (\d+)\)/.exec(e);return s?[parseInt(s[1]),parseInt(s[2]),parseInt(s[3])]:void 0}(a),s.push(a[0],a[1],a[2])})),s=new Uint8Array(s),this.colormap_texture=new o.DataTexture(s,256,1,o.RGBFormat,o.UnsignedByteType),this.colormap_texture.needsUpdate=!0,this.image_material.uniforms.colormap.value=this.colormap_texture}update_image(e){var t=this.model.get("image"),s=null,a=t.data;if(a instanceof Uint8Array)s=o.UnsignedByteType;else if(a instanceof Float64Array)console.warn("ImageGLView.data is a Float64Array which WebGL does not support, will convert to a Float32Array (consider sending float32 data for better performance)."),a=Float32Array.from(a),s=o.FloatType;else{if(!(a instanceof Float32Array))return void console.error("only types uint8 and float32 are supported");s=o.FloatType}this.scales.image.model.get("scheme")&&2==t.shape.length?(this.texture&&this.texture.dispose(),this.texture=new o.DataTexture(a,t.shape[1],t.shape[0],o.LuminanceFormat,s),this.texture.needsUpdate=!0,this.image_material.uniforms.image.value=this.texture,this.image_material.defines.USE_COLORMAP=!0,this.image_material.needsUpdate=!0):3==t.shape.length?(this.image_material.defines.USE_COLORMAP=!1,this.texture&&this.texture.dispose(),3==t.shape[2]&&(this.texture=new o.DataTexture(a,t.shape[1],t.shape[0],o.RGBFormat,s)),4==t.shape[2]&&(this.texture=new o.DataTexture(a,t.shape[1],t.shape[0],o.RGBAFormat,s)),this.texture.needsUpdate=!0,this.image_material.uniforms.image.value=this.texture):console.error("image data not understood"),this.texture.magFilter=h[this.model.get("interpolation")],this.texture.minFilter=h[this.model.get("interpolation")]}update_scene(e){this.parent.update_gl()}render_gl(){var e=this.parent,t=e.renderer,s=(this.model.get("image"),this.scales.x?this.scales.x:this.parent.scale_x),a=this.scales.y?this.scales.y:this.parent.scale_y;this.camera.left=0,this.camera.right=e.plotarea_width,this.camera.bottom=0,this.camera.top=e.plotarea_height,this.camera.updateProjectionMatrix();var i=this.model.get("x"),n=this.model.get("y"),r=i[0],l=i[1],o=n[0],h=n[1],d=s.scale(r),c=s.scale(l),m=a.scale(o),u=c-d,_=a.scale(h)-m;this.image_mesh.position.set(d+u/2,e.plotarea_height-(m+_/2),0),this.image_mesh.scale.set(u,_,1),this.image_material.uniforms.range_x.value=s.scale.range(),this.image_material.uniforms.range_y.value=[a.scale.range()[1],a.scale.range()[0]],this.image_material.uniforms.domain_x.value=s.scale.domain(),this.image_material.uniforms.domain_y.value=a.scale.domain(),this.image_material.uniforms.image_domain_x.value=[r,l],this.image_material.uniforms.image_domain_y.value=[o,h],t.render(this.scene,this.camera),t.domElement}relayout(){this.update_scene()}draw(e){this.set_ranges()}}i.DOMWidgetModel.extend({defaults:n.extend(i.DOMWidgetModel.prototype.defaults(),{_model_name:"ImageMark",_view_name:"HelloView",_model_module:"bqplot-image-gl",_view_module:"bqplot-image-gl",_model_module_version:a,_view_module_version:a,value:"Hello World"})})},1568:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ImageGLModel:()=>a.c,ImageGLView:()=>a.t,ContourModel:()=>i.E,ContourView:()=>i.f,BrushEllipseSelectorModel:()=>n.S,__esModule:()=>n.X,version:()=>h.i});var a=s(8365),i=s(2596),n=s(5588),r=s(922),l={};for(const e in r)["default","ImageGLModel","ImageGLView","ContourModel","ContourView","BrushEllipseSelectorModel","__esModule"].indexOf(e)<0&&(l[e]=()=>r[e]);s.d(t,l);var o=s(7206);l={};for(const e in o)["default","ImageGLModel","ImageGLView","ContourModel","ContourView","BrushEllipseSelectorModel","__esModule"].indexOf(e)<0&&(l[e]=()=>o[e]);s.d(t,l);var h=s(8657)},1961:(e,t,s)=>{var a=s(3469),i=s(2729),n={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array},r={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64"};e.exports={array_or_json:{deserialize:function e(t,s){if(null==t)return null;var i=null;return a.isNumber(t)?t:(a.isArray(t)?0==t.length?arrays=[]:i=a.isArray(t[0])?a.map(t,(function(t){return e(t,s)})):t:t.value&&t.dtype?i=function(e,t){var s=n[e.dtype];null==e&&console.log("data is null"),e.value||console.log("data.buffer is null"),e.value.buffer||console.log("data.buffer is null");var a=new s(e.value.buffer);if(a.type=e.type,e.shape&&e.shape.length>=2){if(e.shape.length>2)throw new Error("only arrays with rank 1 or 2 supported");e.shape;for(var i=[],r=0;r<e.shape[0];r++)i.push(a.slice(r*e.shape[1],(r+1)*e.shape[1]));return i}return a}(t):console.error("not sure what the data is"),i)},serialize:function e(t,s){return null==t?null:a.isNumber(t)?t:a.isArray(t)?t.map((t=>e(t,s))):i(t)?function(e,t){null==e&&console.log("data is null"),e.buffer||console.log("ar.buffer is null or not defined");var s=r[e.constructor.name],a=e.type||null;return{dtype:s,value:new DataView(e.buffer),shape:[e.length],type:a}}(t):void 0}}}},6988:(e,t,s)=>{"use strict";function a(e,t){return Object.keys(t).forEach((s=>e.style(s,t[s]))),e}function i(e,t){return Object.keys(t).forEach((s=>e.attr(s,t[s]))),e}s.r(t),s.d(t,{applyStyles:()=>a,applyAttrs:()=>i})},8657:(e,t,s)=>{"use strict";s.d(t,{i:()=>a});const a=s(306).i8},8288:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});const a="#include <scales>\n\nvarying vec2 pixel_coordinate;\nuniform sampler2D image;\nuniform sampler2D colormap;\nuniform float color_min;\nuniform float color_max;\nuniform float opacity;\n\nuniform vec2 range_x;\nuniform vec2 range_y;\n\nuniform vec2 domain_x;\nuniform vec2 domain_y;\n\nuniform vec2 image_domain_x;\nuniform vec2 image_domain_y;\n\nbool isnan(float val)\n{\n  return (val < 0.0 || 0.0 < val || val == 0.0) ? false : true;\n}\n\n\n\nvoid main(void) {\n    // bring pixels(range) to world space (domain)\n    float x_domain_value = scale_transform_linear_inverse(pixel_coordinate.x, range_x, domain_x);\n    float y_domain_value = scale_transform_linear_inverse(pixel_coordinate.y, range_y, domain_y);\n    // normalize the coordinates for the texture\n    float x_normalized   = scale_transform_linear(x_domain_value, vec2(0., 1.), image_domain_x);\n    float y_normalized   = scale_transform_linear(y_domain_value, vec2(0., 1.), image_domain_y);\n    vec2 tex_uv = vec2(x_normalized, y_normalized);\n#ifdef USE_COLORMAP\n    float raw_value = texture2D(image, tex_uv).r;\n    float value = (raw_value - color_min) / (color_max - color_min);\n    vec4 color;\n    if(isnan(value)) // nan's are interpreted as missing values, and 'not shown'\n        color = vec4(0., 0., 0., 0.);\n    else\n        color = texture2D(colormap, vec2(value, 0.5));\n#else\n    vec4 color = texture2D(image, tex_uv);\n#endif\n    // since we're working with pre multiplied colors (regarding blending)\n    // we also need to multiply rgb by opacity\n    gl_FragColor = color * opacity;\n}\n"},3830:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});const a="varying vec2 pixel_coordinate;\n\nvoid main(void) {\n    vec4 view_position = modelViewMatrix * vec4(position,1.0);\n    pixel_coordinate = view_position.xy;\n    gl_Position = projectionMatrix * view_position;\n}\n"},306:e=>{"use strict";e.exports={i8:"1.3.3"}}}]);